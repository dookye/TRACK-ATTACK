<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Musikraten</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    background-color: #111;
    color: #fff;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    text-align: center;
  }
  h1 {
    margin-bottom: 0.5rem;
  }
  #loginSection, #gameSection {
    margin-top: 1rem;
  }
  button {
    background-color: #1DB954;
    border: none;
    border-radius: 8px;
    padding: 1rem 2rem;
    font-size: 1.2rem;
    cursor: pointer;
    color: white;
    margin: 0.5rem;
    min-width: 180px;
  }
  button:hover:not(:disabled) {
    background-color: #1ed760;
  }
  button:disabled {
    opacity: 0.5;
    cursor: default;
  }
  select {
    font-size: 1.1rem;
    margin: 0.5rem;
    padding: 0.5rem;
  }
  #result, #scoreboard {
    margin-top: 1rem;
    font-size: 1.3rem;
  }
</style>
</head>
<body>

<h1>Musikraten</h1>
<p>Spotify Login mit Premium-Account erforderlich</p>

<div id="loginSection">
  <button id="loginButton">Mit Spotify verbinden</button>
</div>

<div id="gameSection" style="display:none;">
  <label for="genreSelect">Genre auswählen:</label><br />
  <select id="genreSelect">
    <option value="39sVxPTg7BKwrf2MfgrtcD">Punk Rock (90's & 00's)</option>
    <!-- Weitere Playlists hier einfügen -->
  </select><br />

  <label for="modeSelect">Spielmodus wählen:</label><br />
  <select id="modeSelect">
    <option value="30000">Normal (30 Sek.)</option>
    <option value="10000">Profi (10 Sek.)</option>
    <option value="2000">Crack (2 Sek.)</option>
  </select><br />

  <button id="startButton" disabled>START</button>
  <button id="repeatButton" style="display:none;">NOCHMAL HÖREN</button>
  <button id="revealButton" style="display:none;">AUFLÖSEN</button>

  <div id="result"></div>

  <div id="scoreboard">Punkte: 0</div>
</div>

<script>
const clientId = '53257f6a1c144d3f929a60d691a0c6f6';
const redirectUri = 'https://dookye.github.io/musik-raten/';
let accessToken = null;

let playlistId = null;
let playDuration = 3000; // ms
let tracks = [];
let currentTrack = null;
let currentPlayCount = 0;
const maxRepeats = 4;
let score = 0;
let attempts = 0;

const loginButton = document.getElementById('loginButton');
const loginSection = document.getElementById('loginSection');
const gameSection = document.getElementById('gameSection');
const genreSelect = document.getElementById('genreSelect');
const modeSelect = document.getElementById('modeSelect');
const startButton = document.getElementById('startButton');
const repeatButton = document.getElementById('repeatButton');
const revealButton = document.getElementById('revealButton');
const resultDiv = document.getElementById('result');
const scoreboardDiv = document.getElementById('scoreboard');

// --- PKCE Helper Functions ---
function generateRandomString(length) {
  let text = '';
  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  for (let i = 0; i < length; i++) {
    text += possible.charAt(Math.floor(Math.random() * possible.length));
  }
  return text;
}

async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(hash)))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// --- Spotify OAuth2 PKCE ---
async function redirectToSpotifyAuth() {
  const codeVerifier = generateRandomString(64);
  const codeChallenge = await sha256(codeVerifier);
  localStorage.setItem('code_verifier', codeVerifier);

  const scope = [
    'user-read-playback-state',
    'user-modify-playback-state',
    'streaming'
  ].join(' ');

  const args = new URLSearchParams({
    response_type: 'code',
    client_id: clientId,
    scope: scope,
    redirect_uri: redirectUri,
    code_challenge_method: 'S256',
    code_challenge: codeChallenge
  });

  window.location = 'https://accounts.spotify.com/authorize?' + args.toString();
}

async function fetchAccessToken(code) {
  const codeVerifier = localStorage.getItem('code_verifier');
  const body = new URLSearchParams({
    grant_type: 'authorization_code',
    code: code,
    redirect_uri: redirectUri,
    client_id: clientId,
    code_verifier: codeVerifier
  });

  const response = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: body.toString()
  });
  const data = await response.json();
  if (data.access_token) {
    accessToken = data.access_token;
    localStorage.setItem('access_token', accessToken);
    return true;
  } else {
    alert('Fehler beim Abrufen des Zugriffstokens');
    return false;
  }
}

// --- Spotify API Calls ---
async function getPlaylistTracks(playlistId) {
  const allTracks = [];
  let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;
  while (url) {
    const resp = await fetch(url, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const data = await resp.json();
    if (!data.items) break;
    allTracks.push(...data.items.map(i => i.track));
    url = data.next;
  }
  return allTracks;
}

async function getActiveDevice() {
  const resp = await fetch('https://api.spotify.com/v1/me/player/devices', {
    headers: { Authorization: `Bearer ${accessToken}` }
  });
  const data = await resp.json();
  if (!data.devices) return null;
  return data.devices.find(d => d.is_active) || null;
}

async function playTrack(track, deviceId, duration) {
  if (!track || !deviceId) return;
  const maxStart = track.duration_ms - duration;
  const startMs = maxStart > 0 ? Math.floor(Math.random() * maxStart) : 0;

  await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
    method: 'PUT',
    headers: {
      Authorization: `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      uris: [track.uri],
      position_ms: startMs
    })
  });

  // Stop playback after duration
  setTimeout(async () => {
    await fetch(`https://api.spotify.com/v1/me/player/pause?device_id=${deviceId}`, {
      method: 'PUT',
      headers: { Authorization: `Bearer ${accessToken}` }
    });
  }, duration);
}

// --- Spiel-Funktionen ---
async function startGame() {
  startButton.disabled = true;
  repeatButton.style.display = 'none';
  revealButton.style.display = 'none';
  resultDiv.textContent = '';
  attempts = 0;
  currentPlayCount = 0;

  playlistId = genreSelect.value;
  playDuration = parseInt(modeSelect.value);

  try {
    tracks = await getPlaylistTracks(playlistId);
    if (tracks.length === 0) {
      alert('Playlist ist leer!');
      startButton.disabled = false;
      return;
    }
  } catch(e) {
    alert('Fehler beim Laden der Playlist. Bitte versuche es erneut.');
    startButton.disabled = false;
    return;
  }

  await playNewTrack();
  repeatButton.style.display = 'inline-block';
  revealButton.style.display = 'inline-block';
  startButton.textContent = 'NOCHMAL HÖREN';
  startButton.disabled = true; // Disable main start to avoid double clicks
}

async function playNewTrack() {
  currentPlayCount = 0;
  attempts = 0;
  resultDiv.textContent = '';
  currentTrack = tracks[Math.floor(Math.random() * tracks.length)];

  const device = await getActiveDevice();
  if (!device) {
    alert('Bitte starte die Spotify App und spiele einen Song, um ein Gerät zu aktivieren.');
    startButton.disabled = false;
    return;
  }
  await playTrack(currentTrack, device.id, playDuration);
}

async function repeatTrack() {
  if (currentPlayCount >= maxRepeats) {
    alert('Maximale Wiederholungen erreicht!');
    repeatButton.disabled = true;
    return;
  }
  currentPlayCount++;
  attempts++;
  const device = await getActiveDevice();
  if (!device) {
    alert('Bitte starte die Spotify App und spiele einen Song, um ein Gerät zu aktivieren.');
    return;
  }
  await playTrack(currentTrack, device.id, playDuration);
  updateScore(-1); // 1 Punkt Abzug pro Wiederholung
}

function revealAnswer() {
  if (!currentTrack) return;
  resultDiv.innerHTML = `<strong>Interpret:</strong> ${currentTrack.artists.map(a => a.name).join(', ')}<br>
                         <strong>Titel:</strong> ${currentTrack.name}`;
  revealButton.style.display = 'none';
  repeatButton.style.display = 'none';
  startButton.disabled = false;
  startButton.textContent = 'START';

  // Hier könnte Logik für RICHTIG/FALSCH-Buttons kommen
}

function updateScore(points) {
  score = Math.max(0, score + points);
  scoreboardDiv.textContent = `Punkte: ${score}`;
}

// --- Event Listeners ---
loginButton.addEventListener('click', async () => {
  await redirectToSpotifyAuth();
});

startButton.addEventListener('click', async () => {
  if (!accessToken) {
    alert('Bitte zuerst mit Spotify verbinden.');
    return;
  }

  if (startButton.textContent === 'START') {
    await startGame();
  } else if (startButton.textContent === 'NOCHMAL HÖREN') {
    await repeatTrack();
  }
});

repeatButton.addEventListener('click', async () => {
  await repeatTrack();
});

revealButton.addEventListener('click', () => {
  revealAnswer();
});

// --- Initialisierung ---
(async () => {
  // Prüfen ob Code in URL für Auth
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('code')) {
    const code = urlParams.get('code');
    const success = await fetchAccessToken(code);
    if (success) {
      // URL ohne Code bereinigen
      window.history.replaceState({}, document.title, redirectUri);
      loginSection.style.display = 'none';
      gameSection.style.display = 'block';
    }
  } else {
    // Prüfen ob Token im localStorage vorhanden
    accessToken = localStorage.getItem('access_token');
    if (accessToken) {
      loginSection.style.display = 'none';
      gameSection.style.display = 'block';
      startButton.disabled = false;
    }
  }
})();
</script>

</body>
</html>
