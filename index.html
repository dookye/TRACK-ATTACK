<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spotify PKCE Test 009</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; justify-content:center; align-items:center; height:100vh; background:#f0f0f0; flex-direction:column; }
button { padding: 10px 20px; margin: 5px; font-size: 16px; }
#progressBar { width: 100%; height: 20px; background: #ddd; margin-top: 10px; border-radius: 5px; overflow: hidden; }
#progress { height: 100%; width: 0; background: #1DB954; transition: width 0.2s; }
#spinner { border: 6px solid #f3f3f3; border-top: 6px solid #1DB954; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; display:none; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
#playerReady { font-size: 20px; color:#1DB954; opacity:0; transition: opacity 0.5s; margin-bottom:10px; }
#songInfo { margin-top:10px; font-weight:bold; }
</style>
</head>
<body>

<div id="spinner"></div>
<div id="playerReady">Player is ready</div>

<div id="loginDiv">
    <button id="loginButton">Mit Spotify einloggen & Player starten</button>
</div>

<div id="appDiv" style="display:none;">
    <button id="selectButton" disabled>Zufälligen Song auswählen</button>
    <button id="playButton" disabled>Play 10 Sekunden</button>
    <p id="songInfo">Kein Song ausgewählt</p>
    <div id="progressBar"><div id="progress"></div></div>
    <p id="countdown"></p>
</div>

<script>
const clientId = '53257f6a1c144d3f929a60d691a0c6f6';
const redirectUri = 'https://dookye.github.io/TRACK-ATTACK/';
const playlistId = '6Aq2xcWvFXBoExv64eGm5o';
let accessToken = '';
let selectedTrackUri = '';
let deviceId = '';
let player;
let isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

// PKCE Helper
function generateRandomString(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
    return result;
}

async function sha256(baseString) {
    const encoder = new TextEncoder();
    const data = encoder.encode(baseString);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// Spotify Login + Player starten nach Klick
document.getElementById('loginButton').addEventListener('click', async () => {
    const codeVerifier = generateRandomString(128);
    localStorage.setItem('code_verifier', codeVerifier);
    const codeChallenge = await sha256(codeVerifier);

    const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${clientId}&scope=streaming%20user-read-email%20user-read-private%20user-modify-playback-state&redirect_uri=${encodeURIComponent(redirectUri)}&code_challenge_method=S256&code_challenge=${codeChallenge}`;
    window.location = authUrl;
});

// Token holen nach Redirect
async function handleRedirect() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (!code) return;

    const codeVerifier = localStorage.getItem('code_verifier');
    const body = new URLSearchParams();
    body.append('client_id', clientId);
    body.append('grant_type', 'authorization_code');
    body.append('code', code);
    body.append('redirect_uri', redirectUri);
    body.append('code_verifier', codeVerifier);

    const resp = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: body
    });
    const data = await resp.json();
    accessToken = data.access_token;

    if (accessToken) {
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('appDiv').style.display = 'block';
        document.getElementById('spinner').style.display = 'block';
        initPlayer();
    }
}
handleRedirect();

// Spotify Web Playback SDK laden
const script = document.createElement('script');
script.src = "https://sdk.scdn.co/spotify-player.js";
document.body.appendChild(script);

window.onSpotifyWebPlaybackSDKReady = () => { console.log("Spotify SDK ready"); };

// Player initialisieren
function initPlayer() {
    player = new Spotify.Player({
        name: 'TRACK-ATTACK Player',
        getOAuthToken: cb => { cb(accessToken); },
        volume: 0.8
    });

    player.addListener('ready', ({device_id}) => {
        deviceId = device_id;
        console.log('Player ready, Device ID:', device_id);
        document.getElementById('spinner').style.display = 'none';
        const readyEl = document.getElementById('playerReady');
        readyEl.style.opacity = '1';
        setTimeout(() => { readyEl.style.opacity = '0'; }, 1500);
        document.getElementById('selectButton').disabled = false;
    });

    player.connect();
}

// Zufälligen Song auswählen
document.getElementById('selectButton').addEventListener('click', async () => {
    if (!deviceId) return;
    const resp = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, { headers: { Authorization: 'Bearer ' + accessToken } });
    const data = await resp.json();
    const tracks = data.items.map(item => item.track);
    const randomTrack = tracks[Math.floor(Math.random() * tracks.length)];
    selectedTrackUri = randomTrack.uri;
    document.getElementById('songInfo').innerText = `Ausgewählt: ${randomTrack.name} - ${randomTrack.artists.map(a => a.name).join(', ')}`;
    document.getElementById('playButton').disabled = false;
});

// Song 10 Sekunden abspielen
document.getElementById('playButton').addEventListener('click', async () => {
    if (!selectedTrackUri || !deviceId) return;

    document.getElementById('playButton').disabled = true;
    document.getElementById('selectButton').disabled = true;

    await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
        method: 'PUT',
        headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
        body: JSON.stringify({ uris: [selectedTrackUri] })
    });

    let remaining = 10;
    const countdownEl = document.getElementById('countdown');
    const progressEl = document.getElementById('progress');
    countdownEl.innerText = `Verbleibende Zeit: ${remaining}s`;
    progressEl.style.width = '0%';

    const interval = setInterval(() => {
        remaining--;
        countdownEl.innerText = `Verbleibende Zeit: ${remaining}s`;
        progressEl.style.width = `${(10 - remaining)/10*100}%`;
        if (remaining <= 0) {
            clearInterval(interval);
            fetch(`https://api.spotify.com/v1/me/player/pause?device_id=${deviceId}`, { method: 'PUT', headers: { Authorization: 'Bearer ' + accessToken } });
            countdownEl.innerText = 'Abspielzeit beendet';
            progressEl.style.width = '100%';
            document.getElementById('playButton').disabled = false;
            document.getElementById('selectButton').disabled = false;
        }
    }, 1000);
});
</script>
</body>
</html>
