<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spotify PKCE Test</title>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
<h1>Spotify PKCE Test</h1>

<div id="loginDiv">
    <button id="loginButton">Mit Spotify einloggen</button>
</div>

<div id="appDiv" style="display:none;">
    <button id="selectButton">Zufälligen Song auswählen</button>
    <button id="playButton" disabled>Play 10 Sekunden</button>
    <p id="songInfo"></p>
</div>

<script>
const clientId = '53257f6a1c144d3f929a60d691a0c6f6';
const redirectUri = 'https://dookye.github.io/TRACK-ATTACK/';
const playlistId = '6Aq2xcWvFXBoExv64eGm5o';
let accessToken = '';
let selectedTrackUri = '';

function generateRandomString(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// SHA256 & Base64URL encoding
async function sha256(baseString) {
    const encoder = new TextEncoder();
    const data = encoder.encode(baseString);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(hash)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// PKCE Flow: Login
document.getElementById('loginButton').addEventListener('click', async () => {
    const codeVerifier = generateRandomString(128);
    localStorage.setItem('code_verifier', codeVerifier);
    const codeChallenge = await sha256(codeVerifier);

    const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${clientId}&scope=streaming%20user-read-email%20user-read-private&redirect_uri=${encodeURIComponent(redirectUri)}&code_challenge_method=S256&code_challenge=${codeChallenge}`;
    window.location = authUrl;
});

// After redirect: exchange code for token
async function handleRedirect() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (!code) return;

    const codeVerifier = localStorage.getItem('code_verifier');
    const body = new URLSearchParams();
    body.append('client_id', clientId);
    body.append('grant_type', 'authorization_code');
    body.append('code', code);
    body.append('redirect_uri', redirectUri);
    body.append('code_verifier', codeVerifier);

    const resp = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: body
    });
    const data = await resp.json();
    accessToken = data.access_token;

    if (accessToken) {
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('appDiv').style.display = 'block';
        initPlayer();
    }
}

handleRedirect();

// Spotify Web Player
let player;
function initPlayer() {
    window.onSpotifyWebPlaybackSDKReady = () => {
        player = new Spotify.Player({
            name: 'PKCE Test Player',
            getOAuthToken: cb => { cb(accessToken); },
            volume: 0.8
        });

        player.connect();
    };
}

// Zufallssong auswählen
document.getElementById('selectButton').addEventListener('click', async () => {
    const resp = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
        headers: { Authorization: 'Bearer ' + accessToken }
    });
    const data = await resp.json();
    const tracks = data.items.map(item => item.track);
    const randomTrack = tracks[Math.floor(Math.random() * tracks.length)];
    selectedTrackUri = randomTrack.uri;
    document.getElementById('songInfo').innerText = `Ausgewählt: ${randomTrack.name} - ${randomTrack.artists.map(a => a.name).join(', ')}`;
    document.getElementById('playButton').disabled = false;
});

// Song abspielen für 10 Sekunden
document.getElementById('playButton').addEventListener('click', async () => {
    if (!selectedTrackUri) return;

    const resp = await fetch(`https://api.spotify.com/v1/me/player/play`, {
        method: 'PUT',
        headers: {
            Authorization: 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ uris: [selectedTrackUri] })
    });

    setTimeout(() => {
        fetch(`https://api.spotify.com/v1/me/player/pause`, {
            method: 'PUT',
            headers: { Authorization: 'Bearer ' + accessToken }
        });
    }, 10000); // 10 Sekunden
});
</script>
</body>
</html>
