<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRACK ATTACK</title>
    <!-- Chosen Palette: Game Night (Black, Player Blue, Player Pink, White) -->
    <!-- Application Structure Plan: State-driven single-page application. A series of full-screen "views" (divs) are managed by a central JavaScript state machine. This structure directly follows the linear, turn-based flow of the game described in the source report, ensuring a clear and predictable user journey from login to final score. Each game action transitions the user to the next logical view. -->
    <!-- Visualization & Content Choices: 
        - Login/Start: Report Info: Spotify Login, Fullscreen. Goal: Onboarding. Method: Styled buttons, overlays. Interaction: Click. Justification: Clear, sequential entry into the game environment.
        - Game State (Turn, Dice, Genre): Report Info: Player colors, dice choice, genre choice. Goal: Gameplay Setup. Method: CSS background transitions, placeholder buttons for images. Interaction: Click. Justification: Provides visual feedback for player turns and guides the user through pre-round choices.
        - Core Gameplay (Rate): Report Info: Play snippet, reveal answer, score. Goal: Core challenge. Method: Main logo as play button (active/inactive states), dynamic display for track info (text, image placeholder). Interaction: Click to play, click to resolve, click to score. Justification: Centralizes the main action (listening) around the primary brand element (logo).
        - Feedback (Speed Round, Score): Report Info: Timed round, final score display. Goal: Add excitement, show results. Method: CSS animated text (zoom/fade), countdown timer, large text overlay on a gradient. Interaction: None (automatic). Justification: Creates urgency and a clear, climactic end to the game.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce-in {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }
        @keyframes logo-fly-in {
            0% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
            80% { transform: translateY(10px) scale(1.05); opacity: 1; }
            90% { transform: translateY(-5px) scale(1.02); }
            100% { transform: translateY(0) scale(1); }
        }
        @keyframes click-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        @keyframes zoom-fade {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        .screen {
            display: none;
            width: 100vw;
            height: 100vh;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1.5rem;
            animation: bounce-in 0.5s ease-out forwards;
        }
        .screen.active {
            display: flex;
        }
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Helvetica Neue', sans-serif;
            overflow: hidden;
            transition: background-color 0.8s ease;
        }
        .logo-button-animation {
            animation: logo-fly-in 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        .button-bounce {
            animation: click-bounce 0.3s ease-out;
        }
        .blur-effect {
            filter: blur(4px);
            pointer-events: none;
        }
        .genre-blink {
            animation: blink 0.2s infinite alternate;
        }
        @keyframes blink {
            from { background-color: #4A90E2; }
            to { background-color: #8A63D2; }
        }
        .game-button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.25rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .game-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: white;
        }
        .dice-button {
            width: 100px;
            height: 100px;
            background-color: #333;
            border: 2px solid #555;
            border-radius: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
        }
        #logo-button-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }
        #logo-button {
            width: 150px;
            height: 150px;
            background-color: #1DB954; /* Placeholder for logo3.png */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: black;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.7);
            transition: filter 0.3s ease;
        }
        #speed-round-indicator, #timer-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            font-weight: bold;
            z-index: 200;
            opacity: 0;
        }
    </style>
</head>
<body>

    <div id="orientation-screen" class="screen fixed inset-0 bg-black z-[9999]">
        <p class="text-2xl text-center p-4">Please rotate your device to Landscape mode.</p>
    </div>

    <div id="login-screen" class="screen active">
        <div class="text-center">
            <h1 class="text-4xl font-bold mb-4">TRACK ATTACK</h1>
            <p class="mb-8">Please log in with your Spotify-Premium-Account</p>
            <button id="login-button" class="bg-[#1DB954] text-white font-bold py-4 px-8 rounded-full text-lg hover:bg-[#1ED760] transition-colors">
                Login with Spotify
            </button>
        </div>
    </div>
    
    <div id="fullscreen-screen" class="screen">
        <div class="text-center cursor-pointer">
            <h2 class="text-4xl font-bold animate-pulse">Klick to Fullscreen</h2>
        </div>
    </div>

    <div id="game-container" class="hidden">
        
        <div id="logo-button-container" class="hidden">
            <div id="logo-button">LOGO</div>
        </div>

        <div id="dice-screen" class="screen">
            <div id="dice-animation" class="w-48 h-48 bg-gray-700 rounded-lg flex items-center justify-center text-xl mb-4">
                Würfel-Animation... (w-ani.gif)
            </div>
            <div id="dice-selection" class="hidden flex gap-4">
                <!-- Placeholder for w-3.png -->
                <button data-dice="3" class="dice-button game-button">3</button>
                <!-- Placeholder for w-4.png -->
                <button data-dice="4" class="dice-button game-button">4</button>
                <!-- Placeholder for w-5.png -->
                <button data-dice="5" class="dice-button game-button">5</button>
                <!-- Placeholder for w-7.png -->
                <button data-dice="7" class="dice-button game-button">7</button>
            </div>
        </div>

        <div id="genre-screen" class="screen">
            <h2 class="text-3xl font-bold mb-8">Wähle ein Genre</h2>
            <div id="genre-selection" class="grid grid-cols-2 gap-4">
                <button data-genre="punk" class="game-button">Punk Rock (90's & 00')</button>
                <button data-genre="pop" class="game-button">Pop Hits 2000-2025</button>
                <button data-genre="alltime" class="game-button">Die größten Hits aller Zeiten</button>
                <button data-genre="disney" class="game-button">Disney Songs</button>
            </div>
        </div>
        
        <div id="rate-screen" class="screen">
            <div id="resolve-container" class="hidden text-center">
                <img id="album-cover" src="https://placehold.co/300x300/000000/FFFFFF?text=Album+Art" alt="Album Cover" class="w-48 h-48 md:w-64 md:h-64 rounded-lg mx-auto mb-4 border-2 border-white">
                <p id="track-title" class="text-2xl font-bold">Titel</p>
                <p id="track-artist" class="text-xl text-gray-300">Interpret</p>
                <div class="mt-8 flex gap-4">
                    <button id="correct-button" class="game-button bg-green-500 hover:bg-green-600">RICHTIG</button>
                    <button id="false-button" class="game-button bg-red-500 hover:bg-red-600">FALSCH</button>
                </div>
            </div>
            <button id="resolve-button" class="game-button hidden">AUFLÖSEN</button>
        </div>

        <div id="score-screen" class="screen">
            <div class="flex justify-around w-full text-center">
                <div class="player-1-score">
                    <h2 class="text-4xl mb-4" style="color:#3B82F6;">Spieler 1</h2>
                    <p id="player1-final-score" class="text-8xl font-bold">0</p>
                </div>
                 <div class="player-2-score">
                    <h2 class="text-4xl mb-4" style="color:#EC4899;">Spieler 2</h2>
                    <p id="player2-final-score" class="text-8xl font-bold">0</p>
                </div>
            </div>
        </div>
        
        <div id="speed-round-indicator">Speed-Round</div>
        <div id="timer-indicator">10</div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const CLIENT_ID = '53257f6a1c144d3f929a60d691a0c6f6';
            const REDIRECT_URI = 'https://dookye.github.io/TRACK-ATTACK/';

            const playerColors = { 1: '#3B82F6', 2: '#EC4899' };
            const playlists = {
                punk: ['39sVxPTg7BKwrf2MfgrtcD', '7ITmaFa2rOhXAmKmUUCG9E'],
                pop: ['6mtYuOxzl58vSGnEDtZ9uB', '34NbomaTu7YuOYnky8nLXL'],
                alltime: ['2si7ChS6Y0hPBt4FsobXpg', '2y09fNnXHvoqc1WGHvbhkZ'],
                disney: ['3Bilb56eeS7db5f3DTEwMR', '2bhbwexk7c6yJrEB4CtuY8']
            };

            let gameState = {};
            let player;
            let deviceId;
            let accessToken;
            let currentTrack = null;
            let speedRoundTimer;

            const screens = {
                login: document.getElementById('login-screen'),
                fullscreen: document.getElementById('fullscreen-screen'),
                orientation: document.getElementById('orientation-screen'),
                dice: document.getElementById('dice-screen'),
                genre: document.getElementById('genre-screen'),
                rate: document.getElementById('rate-screen'),
                score: document.getElementById('score-screen')
            };

            const elements = {
                loginButton: document.getElementById('login-button'),
                fullscreenScreen: document.getElementById('fullscreen-screen'),
                gameContainer: document.getElementById('game-container'),
                logoButtonContainer: document.getElementById('logo-button-container'),
                logoButton: document.getElementById('logo-button'),
                diceAnimation: document.getElementById('dice-animation'),
                diceSelection: document.getElementById('dice-selection'),
                diceButtons: document.querySelectorAll('[data-dice]'),
                genreSelection: document.getElementById('genre-selection'),
                genreButtons: document.querySelectorAll('[data-genre]'),
                resolveButton: document.getElementById('resolve-button'),
                resolveContainer: document.getElementById('resolve-container'),
                albumCover: document.getElementById('album-cover'),
                trackTitle: document.getElementById('track-title'),
                trackArtist: document.getElementById('track-artist'),
                correctButton: document.getElementById('correct-button'),
                falseButton: document.getElementById('false-button'),
                player1FinalScore: document.getElementById('player1-final-score'),
                player2FinalScore: document.getElementById('player2-final-score'),
                speedRoundIndicator: document.getElementById('speed-round-indicator'),
                timerIndicator: document.getElementById('timer-indicator')
            };

            const resetGameState = () => {
                gameState = {
                    currentPlayer: 1,
                    round: 1,
                    player1Score: 0,
                    player2Score: 0,
                    player1SpeedRound: Math.ceil(Math.random() * 10),
                    player2SpeedRound: Math.ceil(Math.random() * 10),
                    dice: null,
                    attempts: 0,
                    genre: null,
                    isGameActive: false
                };
            };
            
            const checkOrientation = () => {
                if (window.innerHeight > window.innerWidth) {
                    screens.orientation.style.display = 'flex';
                } else {
                    screens.orientation.style.display = 'none';
                }
            };
            
            const showScreen = (screenName) => {
                Object.values(screens).forEach(s => s.classList.remove('active'));
                if (screens[screenName]) {
                    screens[screenName].classList.add('active');
                }
            };

            async function generateCodeChallenge(codeVerifier) {
                const data = new TextEncoder().encode(codeVerifier);
                const digest = await window.crypto.subtle.digest('SHA-256', data);
                return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            }

            function generateRandomString(length) {
                let text = '';
                const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                for (let i = 0; i < length; i++) {
                    text += possible.charAt(Math.floor(Math.random() * possible.length));
                }
                return text;
            }

            elements.loginButton.addEventListener('click', async () => {
                const codeVerifier = generateRandomString(128);
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                window.sessionStorage.setItem('code_verifier', codeVerifier);
                const scope = 'streaming user-read-email user-read-private';
                const authUrl = new URL("https://accounts.spotify.com/authorize");
                const params = {
                    response_type: 'code',
                    client_id: CLIENT_ID,
                    scope,
                    code_challenge_method: 'S256',
                    code_challenge: codeChallenge,
                    redirect_uri: REDIRECT_URI,
                };
                authUrl.search = new URLSearchParams(params).toString();
                window.location.href = authUrl.toString();
            });

            const handleRedirect = async () => {
                const urlParams = new URLSearchParams(window.location.search);
                let code = urlParams.get('code');
                if (code) {
                    const codeVerifier = window.sessionStorage.getItem('code_verifier');
                    const payload = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', },
                        body: new URLSearchParams({
                            client_id: CLIENT_ID,
                            grant_type: 'authorization_code',
                            code,
                            redirect_uri: REDIRECT_URI,
                            code_verifier: codeVerifier,
                        }),
                    };
                    const body = await fetch("https://accounts.spotify.com/api/token", payload);
                    const response = await body.json();
                    if (response.access_token) {
                        accessToken = response.access_token;
                        window.history.pushState({}, '', '/'); 
                        showScreen('fullscreen');
                        loadSpotifyPlayer();
                    }
                }
            };
            
            const loadSpotifyPlayer = () => {
                const script = document.createElement('script');
                script.src = "https://sdk.scdn.co/spotify-player.js";
                script.async = true;
                document.body.appendChild(script);

                window.onSpotifyWebPlaybackSDKReady = () => {
                    player = new Spotify.Player({
                        name: 'TRACK ATTACK',
                        getOAuthToken: cb => { cb(accessToken); },
                        volume: 0.5
                    });
                    player.addListener('ready', ({ device_id }) => {
                        console.log('Ready with Device ID', device_id);
                        deviceId = device_id;
                    });
                    player.addListener('not_ready', ({ device_id }) => {
                        console.log('Device ID has gone offline', device_id);
                    });
                    player.connect();
                };
            };
            
            elements.fullscreenScreen.addEventListener('click', () => {
                document.documentElement.requestFullscreen().then(() => {
                    showScreen(null);
                    elements.gameContainer.style.display = 'block';
                    elements.logoButtonContainer.style.display = 'block';
                    elements.logoButton.classList.add('logo-button-animation');
                    resetGameState();
                }).catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            });

            function applyBounce(e) {
                e.currentTarget.classList.add('button-bounce');
                setTimeout(() => e.currentTarget.classList.remove('button-bounce'), 300);
            }

            function setLogoActive(isActive) {
                if (isActive) {
                    elements.logoButton.classList.remove('blur-effect');
                } else {
                    elements.logoButton.classList.add('blur-effect');
                }
            }

            elements.logoButton.addEventListener('click', (e) => {
                applyBounce(e);
                if (!gameState.isGameActive) {
                    gameState.isGameActive = true;
                    startGame();
                } else {
                    playSongSnippet();
                }
            });

            function startGame() {
                setLogoActive(false);
                setTimeout(() => {
                    document.body.style.backgroundColor = playerColors[gameState.currentPlayer];
                    showScreen('dice');
                    elements.diceAnimation.style.display = 'flex';
                    elements.diceSelection.classList.add('hidden');
                    setTimeout(() => {
                        elements.diceAnimation.style.display = 'none';
                        elements.diceSelection.classList.remove('hidden');
                    }, 4000);
                }, 500);
            }

            elements.diceButtons.forEach(button => {
                button.addEventListener('click', e => {
                    applyBounce(e);
                    gameState.dice = parseInt(e.currentTarget.dataset.dice);
                    gameState.attempts = gameState.dice;
                    showScreen('genre');
                    handleGenreSelection();
                });
            });
            
            function handleGenreSelection() {
                const genreBtns = Array.from(elements.genreButtons);
                genreBtns.forEach(b => b.classList.remove('blur-effect', 'genre-blink'));

                if (gameState.dice === 7) {
                    // Free choice
                } else {
                    // Random selection
                    genreBtns.forEach(b => b.classList.add('blur-effect'));
                    let intervalCount = 0;
                    const interval = setInterval(() => {
                        genreBtns.forEach(b => b.classList.remove('genre-blink'));
                        genreBtns[Math.floor(Math.random() * genreBtns.length)].classList.add('genre-blink');
                        intervalCount++;
                        if (intervalCount > 20) { // 4 seconds
                            clearInterval(interval);
                            genreBtns.forEach(b => b.classList.remove('genre-blink', 'blur-effect'));
                            const chosenGenre = genreBtns[Math.floor(Math.random() * genreBtns.length)];
                            gameState.genre = chosenGenre.dataset.genre;
                            genreBtns.forEach(b => {
                                if (b !== chosenGenre) b.classList.add('blur-effect');
                            });
                        }
                    }, 200);
                }
            }

            elements.genreButtons.forEach(button => {
                button.addEventListener('click', e => {
                    if(e.currentTarget.classList.contains('blur-effect')) return;
                    applyBounce(e);
                    if (gameState.dice === 7) {
                        gameState.genre = e.currentTarget.dataset.genre;
                    }
                    prepareRateScreen();
                });
            });

            async function prepareRateScreen() {
                 const isSpeed = (gameState.currentPlayer === 1 && gameState.round === gameState.player1SpeedRound) || (gameState.currentPlayer === 2 && gameState.round === gameState.player2SpeedRound);

                if (isSpeed) {
                    elements.speedRoundIndicator.style.animation = 'zoom-fade 4s ease-in-out forwards';
                    await new Promise(resolve => setTimeout(resolve, 4000));
                    elements.speedRoundIndicator.style.animation = 'none';
                }

                showScreen('rate');
                setLogoActive(true);
                elements.resolveContainer.classList.add('hidden');
                elements.resolveButton.classList.add('hidden');
                
                if (isSpeed) {
                    startSpeedRoundTimer();
                }
            }
            
            async function playSongSnippet() {
                if(gameState.attempts <= 0) return;
                setLogoActive(false);
                gameState.attempts--;

                if (!currentTrack) {
                    const playlistId = playlists[gameState.genre][Math.floor(Math.random() * 2)];
                    const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const data = await response.json();
                    const tracks = data.items.filter(item => item.track && item.track.preview_url);
                    currentTrack = tracks[Math.floor(Math.random() * tracks.length)].track;
                }
                
                const duration_ms = currentTrack.duration_ms;
                const playDuration = (gameState.dice === 7 ? 2 : 7) * 1000;
                const randomPosition = Math.floor(Math.random() * (duration_ms - playDuration));

                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ uris: [currentTrack.uri], position_ms: randomPosition }),
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                });

                setTimeout(() => {
                    player.pause();
                    if(gameState.attempts > 0) {
                       setLogoActive(true);
                    }
                    if(!elements.resolveButton.classList.contains('hidden')) return;
                    elements.resolveButton.classList.remove('hidden');
                }, playDuration);
            }
            
            elements.resolveButton.addEventListener('click', (e) => {
                applyBounce(e);
                resolveRound();
            });

            function resolveRound() {
                if(speedRoundTimer) clearInterval(speedRoundTimer);
                setLogoActive(false);
                elements.resolveButton.classList.add('hidden');
                elements.resolveContainer.classList.remove('hidden');
                elements.albumCover.src = currentTrack.album.images[0].url;
                elements.trackTitle.innerText = currentTrack.name;
                elements.trackArtist.innerText = currentTrack.artists.map(a => a.name).join(', ');
            }
            
            function nextTurn() {
                currentTrack = null;
                elements.resolveContainer.classList.add('hidden');

                if (gameState.currentPlayer === 2) {
                    gameState.round++;
                }

                if(gameState.round > 10) {
                    endGame();
                    return;
                }

                gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
                startGame();
            }

            elements.correctButton.addEventListener('click', e => {
                applyBounce(e);
                const points = gameState.dice - (gameState.dice - gameState.attempts - 1);
                if(gameState.currentPlayer === 1) gameState.player1Score += points;
                else gameState.player2Score += points;
                nextTurn();
            });

            elements.falseButton.addEventListener('click', e => {
                applyBounce(e);
                nextTurn();
            });
            
            function startSpeedRoundTimer() {
                let timeLeft = 10;
                elements.timerIndicator.innerText = timeLeft;
                elements.timerIndicator.style.animation = 'bounce-in 1s forwards';
                speedRoundTimer = setInterval(() => {
                    timeLeft--;
                    elements.timerIndicator.innerText = timeLeft;
                    if(timeLeft <= 0) {
                        clearInterval(speedRoundTimer);
                        elements.timerIndicator.style.animation = 'none';
                        elements.timerIndicator.style.opacity = '0';
                        resolveRound();
                    }
                }, 1000);
            }
            
            function endGame() {
                showScreen('score');
                document.body.style.background = 'linear-gradient(to right, #3B82F6, #EC4899)';
                elements.player1FinalScore.innerText = gameState.player1Score;
                elements.player2FinalScore.innerText = gameState.player2Score;
                setTimeout(() => {
                    document.body.style.background = '#000';
                    resetGameState();
                    showScreen(null); // Back to start screen with logo
                }, 7000);
            }

            window.addEventListener('resize', checkOrientation);
            checkOrientation();
            handleRedirect();
        });
    </script>
</body>
</html>
