<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Musik Raten</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #app {
      text-align: center;
    }
    button {
      background-color: #1DB954;
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 24px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #1aa34a;
    }
  </style>
</head>
<body>
  <div id="app">
    <button id="startButton">START</button>
  </div>

  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
    const clientId = '53257f6a1c144d3f929a60d691a0c6f6';
    const playlistId = '39sVxPTg7BKwrf2MfgrtcD';
    let accessToken = null;
    let deviceId = null;

    // 1. Redirect to Spotify login
    function redirectToSpotifyAuth() {
      const redirectUri = window.location.href;
      const scopes = [
        'streaming',
        'user-read-email',
        'user-read-private',
        'user-modify-playback-state',
        'user-read-playback-state'
      ];

      window.location =
        `https://accounts.spotify.com/authorize?response_type=token` +
        `&client_id=${clientId}` +
        `&scope=${scopes.join('%20')}` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}`;
    }

    // 2. Get access token from URL hash
    function getTokenFromUrl() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return params.get('access_token');
    }

    // 3. Load Spotify SDK
    window.onSpotifyWebPlaybackSDKReady = () => {
      const token = accessToken;
      const player = new Spotify.Player({
        name: 'Musik Raten Player',
        getOAuthToken: cb => { cb(token); },
        volume: 0.8
      });

      player.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        console.log('Ready with Device ID', deviceId);
      });

      player.addListener('not_ready', ({ device_id }) => {
        console.log('Device ID has gone offline', device_id);
      });

      player.connect();
    };

    // 4. Play random song for 3 seconds
    async function playRandomSong() {
      if (!accessToken || !deviceId) return;

      // Get playlist tracks
      const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
        headers: {
          Authorization: `Bearer ${accessToken}`
        }
      });
      const data = await response.json();
      const tracks = data.items;
      const uris = tracks.map(item => item.track.uri);

      // Pick a random track
      const randomIndex = Math.floor(Math.random() * uris.length);
      const randomUri = uris[randomIndex];
      const randomPosition = Math.floor(Math.random() * 60000); // up to 60s

      // Play the track
      await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
        method: 'PUT',
        body: JSON.stringify({
          uris: [randomUri],
          position_ms: randomPosition
        }),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`
        }
      });

      // Stop after 3 seconds
      setTimeout(() => {
        fetch(`https://api.spotify.com/v1/me/player/pause?device_id=${deviceId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });
      }, 3000);
    }

    // 5. Handle start button
    document.getElementById('startButton').addEventListener('click', () => {
      if (!accessToken) {
        redirectToSpotifyAuth();
      } else {
        playRandomSong();
      }
    });

    // 6. On load
    window.onload = () => {
      accessToken = getTokenFromUrl();
      if (accessToken) {
        window.history.pushState({}, document.title, "/"); // clean URL
      }
    }
  </script>
</body>
</html>
