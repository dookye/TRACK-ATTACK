<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRACK ATTACK001</title>
    <style>
        /* Grundlegende Stile und Resets */
        :root {
            --player1-color: #0077ff; /* Leuchtendes Blau */
            --player2-color: #ff1493; /* Leuchtendes Pink */
            --border-gradient: linear-gradient(45deg, var(--player1-color), var(--player2-color), white);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none; /* Verhindert Textauswahl */
            -webkit-tap-highlight-color: transparent; /* Entfernt Klick-Highlight auf Mobilgeräten */
            outline: none; /* Entfernt den Fokus-Rahmen */
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            color: white;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: background-color 0.8s ease;
        }

        a, button {
            text-decoration: none;
            outline: none;
        }

        /* Verstecktes Element */
        .hidden {
            display: none !important;
        }

        /* Overlays (Fullscreen, Rotate) */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            cursor: pointer;
        }

        .overlay h1 {
            font-size: 2.5rem;
            padding: 20px;
        }

        /* Login-Bildschirm */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        #login-screen p {
            font-size: 1.2rem;
        }

        #login-button {
            background-color: #1DB954;
            color: white;
            border: none;
            border-radius: 500px;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s ease;
        }

        #login-button:hover {
            transform: scale(1.05);
        }

        #login-button img {
            width: 30px;
            height: 30px;
        }

        /* Spiel-Container */
        #game-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            position: relative;
        }

        /* Logo-spezifische Stile */
        #logo-container {
            position: relative;
        }

        #logo-button {
            width: 200px;
            height: auto;
            cursor: pointer;
            transition: filter 0.3s ease, transform 0.2s ease;
        }

        #logo-button.inactive {
            filter: blur(5px);
            pointer-events: none;
        }
        
        #logo-button.playing {
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* Animationen */
        @keyframes initial-logo-animation {
            0% {
                transform: scale(4);
                opacity: 0;
            }
            80% {
                transform: scale(0.95);
                opacity: 1;
            }
            90% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .initial-animation {
            animation: initial-logo-animation 1.5s ease-out forwards;
        }

        @keyframes bounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .bounce-animation {
            animation: bounce 0.4s ease;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Würfel- und Genre-Bildschirme */
        .choice-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #dice-animation {
            width: 250px;
        }

        #dice-buttons, #genre-buttons {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .dice-btn {
            background: none;
            border: none;
            cursor: pointer;
        }

        .dice-btn img {
            width: 100px;
            transition: transform 0.2s ease;
        }
        
        .dice-btn:hover img {
            transform: scale(1.1);
        }

        .genre-btn {
            background-color: #000;
            color: #fff;
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 15px 30px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            background-clip: padding-box;
            position: relative;
            transition: transform 0.2s ease, opacity 0.3s ease;
        }
        
        .genre-btn::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -3px;
            border-radius: inherit;
            background: var(--border-gradient);
        }

        .genre-btn.inactive {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .genre-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--player1-color), 0 0 20px var(--player2-color);
        }

        @keyframes blink-genre {
            50% {
                opacity: 0.6;
            }
        }

        .blinking {
            animation: blink-genre 0.5s infinite;
        }

        /* Rate-Bildschirm */
        #action-buttons {
            position: absolute;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .action-btn {
            background-color: #000;
            color: #fff;
            border: 3px solid transparent;
            border-radius: 500px;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            background-clip: padding-box;
            position: relative;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -3px;
            border-radius: inherit;
            background: var(--border-gradient);
        }
        
        /* Auflösungs-Bildschirm */
        #reveal-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background-color: rgba(0,0,0,0.7);
            padding: 30px;
            border-radius: 20px;
        }

        #album-cover {
            width: 200px;
            height: 200px;
            border-radius: 10px;
        }
        
        #song-info h2 {
            font-size: 2rem;
        }
        
        #song-info p {
            font-size: 1.5rem;
            color: #ccc;
        }
        
        #judgement-buttons {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* Speed-Round / Countdown Anzeige */
        #special-message-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 500;
            font-size: 8rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 20px black;
            pointer-events: none;
            opacity: 0;
        }

        @keyframes special-message-animation {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        @keyframes fade-out {
            to { opacity: 0; }
        }

        /* End-Bildschirm */
        #end-screen {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: linear-gradient(90deg, var(--player1-color), var(--player2-color));
        }
        
        .score-display {
            font-size: 15rem;
            font-weight: bold;
            opacity: 0;
            animation: fade-in 1s forwards;
        }
        
        @keyframes fade-in {
            to { opacity: 1; }
        }

    </style>
</head>
<body>

    <!-- Login-Bildschirm -->
    <div id="login-screen">
        <p>Please log in with your Spotify-Premium-Account.</p>
        <button id="login-button">
            <img src="https://storage.googleapis.com/pr-newsroom-wp/1/2018/11/Spotify_Icon_RGB_White.png" alt="Spotify Logo">
            <span>LOG IN</span>
        </button>
    </div>

    <!-- Haupt-Spielcontainer -->
    <div id="game-container" class="hidden">
        
        <!-- Logo als zentraler Button -->
        <div id="logo-container">
             <img src="https://raw.githubusercontent.com/Dookye/TRACK-ATTACK/main/logo3.png" alt="Track Attack Logo" id="logo-button">
        </div>

        <!-- Würfel-Bildschirm -->
        <div id="dice-screen" class="choice-screen hidden">
            <img src="https://raw.githubusercontent.com/Dookye/TRACK-ATTACK/main/w-ani.gif" alt="Dice Animation" id="dice-animation">
            <div id="dice-buttons" class="hidden">
                <button class="dice-btn" data-value="3"><img src="https://raw.githubusercontent.com/Dookye/TRACK-ATTACK/main/w-3.png" alt="Dice 3"></button>
                <button class="dice-btn" data-value="4"><img src="https://raw.githubusercontent.com/Dookye/TRACK-ATTACK/main/w-4.png" alt="Dice 4"></button>
                <button class="dice-btn" data-value="5"><img src="https://raw.githubusercontent.com/Dookye/TRACK-ATTACK/main/w-5.png" alt="Dice 5"></button>
                <button class="dice-btn" data-value="7"><img src="https://raw.githubusercontent.com/Dookye/TRACK-ATTACK/main/w-7.png" alt="Dice 7"></button>
            </div>
        </div>

        <!-- Genre-Bildschirm -->
        <div id="genre-screen" class="choice-screen hidden">
            <div id="genre-buttons">
                <button class="genre-btn" data-genre="punk">Punk Rock (90's & 00')</button>
                <button class="genre-btn" data-genre="pop">Pop Hits 2000-2025</button>
                <button class="genre-btn" data-genre="alltime">Die größten Hits aller Zeiten</button>
                <button class="genre-btn" data-genre="disney">Disney Songs</button>
            </div>
        </div>
        
        <!-- Auflösungs-Bildschirm -->
        <div id="reveal-screen" class="hidden">
            <img id="album-cover" src="" alt="Album Cover">
            <div id="song-info">
                <h2 id="song-title"></h2>
                <p id="song-artist"></p>
            </div>
            <div id="judgement-buttons">
                 <button class="action-btn" id="correct-btn">RICHTIG</button>
                 <button class="action-btn" id="wrong-btn">FALSCH</button>
            </div>
        </div>

        <!-- Buttons am unteren Rand (Auflösen) -->
        <div id="action-buttons">
            <button class="action-btn hidden" id="reveal-btn">AUFLÖSEN</button>
        </div>
        
        <!-- Container für Speed-Round / Countdown Nachrichten -->
        <div id="special-message-container"></div>

    </div>
    
    <!-- End-Bildschirm -->
    <div id="end-screen" class="hidden">
        <div id="player1-final-score" class="score-display"></div>
        <div id="player2-final-score" class="score-display"></div>
    </div>

    <!-- Overlay für Geräte-Ausrichtung -->
    <div id="rotate-device-overlay" class="overlay hidden">
        <h1>Please rotate your device to landscape mode</h1>
    </div>

    <!-- Overlay für Vollbild-Aufforderung -->
    <div id="fullscreen-overlay" class="overlay hidden">
        <h1>Click to enter Fullscreen</h1>
    </div>


    <script>
        // --- KONSTANTEN UND VARIABLEN ---
        const CLIENT_ID = "53257f6a1c144d3f929a60d691a0c6f6";
        const REDIRECT_URI = "https://dookye.github.io/TRACK-ATTACK/";
        const SCOPES = "streaming user-read-email user-read-private";

        const playlists = {
            punk: ['39sVxPTg7BKwrf2MfgrtcD', '7ITmaFa2rOhXAmKmUUCG9E'],
            pop: ['6mtYuOxzl58vSGnEDtZ9uB', '34NbomaTu7YuOYnky8nLXL'],
            alltime: ['2si7ChS6Y0hPBt4FsobXpg', '2y09fNnXHvoqc1WGHvbhkZ'],
            disney: ['3Bilb56eeS7db5f3DTEwMR', '2bhbwexk7c6yJrEB4CtuY8']
        };

        let gameState = {
            player1Score: 0,
            player2Score: 0,
            currentPlayer: 1,
            currentRound: 1,
            totalRounds: 20,
            player1SpeedRound: -1,
            player2SpeedRound: -1,
            isGameActive: false
        };

        let roundState = {
            diceValue: 0,
            attemptsMade: 0,
            maxAttempts: 0,
            songDuration: 0,
            selectedGenre: null,
            currentTrack: null,
            speedRoundTimer: null
        };

        let spotifyPlayer = null;
        let deviceId = null;
        let accessToken = null;

        // --- DOM-ELEMENTE ---
        const loginScreen = document.getElementById('login-screen');
        const gameContainer = document.getElementById('game-container');
        const loginButton = document.getElementById('login-button');
        const rotateOverlay = document.getElementById('rotate-device-overlay');
        const fullscreenOverlay = document.getElementById('fullscreen-overlay');
        const logoButton = document.getElementById('logo-button');
        const diceScreen = document.getElementById('dice-screen');
        const diceAnimation = document.getElementById('dice-animation');
        const diceButtons = document.getElementById('dice-buttons');
        const genreScreen = document.getElementById('genre-screen');
        const genreButtons = document.querySelectorAll('.genre-btn');
        const revealBtn = document.getElementById('reveal-btn');
        const revealScreen = document.getElementById('reveal-screen');
        const correctBtn = document.getElementById('correct-btn');
        const wrongBtn = document.getElementById('wrong-btn');
        const specialMessageContainer = document.getElementById('special-message-container');
        const endScreen = document.getElementById('end-screen');


        // --- AUTHENTIFIZIERUNG (PKCE Flow) ---

        // Generiert einen zufälligen String für den Code Verifier
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        // Erstellt einen SHA256 Hash
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        // Base64-URL-kodiert den Hash
        function base64encode(input) {
            return btoa(String.fromCharCode(...new Uint8Array(input)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        // Startet den Login-Prozess
        async function redirectToSpotifyAuth() {
            const codeVerifier = generateRandomString(64);
            window.localStorage.setItem('code_verifier', codeVerifier);
            const hashed = await sha256(codeVerifier);
            const codeChallenge = base64encode(hashed);

            const authUrl = new URL("https://accounts.spotify.com/authorize");
            const params = {
                response_type: 'code',
                client_id: CLIENT_ID,
                scope: SCOPES,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge,
                redirect_uri: REDIRECT_URI,
            };
            authUrl.search = new URLSearchParams(params).toString();
            window.location.href = authUrl.toString();
        }

        // Tauscht den Authorization Code gegen ein Access Token
        async function fetchAccessToken(code) {
            const codeVerifier = localStorage.getItem('code_verifier');
            const response = await fetch("https://accounts.spotify.com/api/token", {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    client_id: CLIENT_ID,
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    code_verifier: codeVerifier,
                }),
            });
            if (!response.ok) {
                throw new Error('Failed to fetch access token');
            }
            const data = await response.json();
            accessToken = data.access_token;
            // Hier sollte auch das refresh_token gespeichert werden für längere Sessions
            initializeWebPlayer();
        }

        // --- SPOTIFY WEB PLAYBACK SDK ---

        function initializeWebPlayer() {
            const script = document.createElement('script');
            script.src = "https://sdk.scdn.co/spotify-player.js";
            script.async = true;
            document.body.appendChild(script);

            window.onSpotifyWebPlaybackSDKReady = () => {
                spotifyPlayer = new Spotify.Player({
                    name: 'TRACK ATTACK',
                    getOAuthToken: cb => { cb(accessToken); },
                    volume: 0.5
                });

                spotifyPlayer.addListener('ready', ({ device_id }) => {
                    console.log('Ready with Device ID', device_id);
                    deviceId = device_id;
                    // Login erfolgreich, UI vorbereiten
                    loginScreen.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                    checkOrientation(); // Erste Prüfung nach dem Login
                });

                spotifyPlayer.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                });
                
                spotifyPlayer.addListener('player_state_changed', state => {
                    if (!state) return;
                    
                    // Logik, wenn Song zu Ende ist (oder pausiert wird)
                    if (state.paused && roundState.currentTrack && !state.track_window.next_tracks.length) {
                        // Dies ist eine sehr einfache Prüfung. Besser wäre es, den Timer zu nutzen.
                    }
                });

                spotifyPlayer.connect().then(success => {
                    if (success) {
                        console.log('The Web Playback SDK successfully connected to Spotify!');
                    }
                });
            };
        }

        // --- BILDSCHIRM- & GERÄTE-SETUP ---

        function checkOrientation() {
            if (window.innerHeight > window.innerWidth) { // Portrait-Modus
                rotateOverlay.classList.remove('hidden');
                fullscreenOverlay.classList.add('hidden'); // Verstecke Fullscreen, falls sichtbar
            } else { // Landscape-Modus
                rotateOverlay.classList.add('hidden');
                // Wenn nicht im Vollbild, zeige den Vollbild-Button
                if (!document.fullscreenElement) {
                    fullscreenOverlay.classList.remove('hidden');
                } else {
                    fullscreenOverlay.classList.add('hidden');
                }
            }
        }
        
        function enterFullscreen() {
            document.documentElement.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        }

        function handleFullscreenChange() {
            if (!document.fullscreenElement) {
                // User hat Vollbild verlassen, zeige Aufforderung erneut (nur im Landscape)
                checkOrientation();
            } else {
                 // User ist im Vollbild, starte ggf. die Intro-Animation
                if (!gameState.isGameActive) {
                    fullscreenOverlay.classList.add('hidden');
                    logoButton.classList.add('initial-animation');
                }
            }
        }

        // --- SPIEL-LOGIK ---
        
        function resetGame() {
            gameState = {
                player1Score: 0,
                player2Score: 0,
                currentPlayer: 1,
                currentRound: 1,
                totalRounds: 20,
                player1SpeedRound: Math.ceil(Math.random() * (gameState.totalRounds / 2)),
                player2SpeedRound: Math.ceil(Math.random() * (gameState.totalRounds / 2)),
                isGameActive: true
            };
            document.body.style.backgroundColor = '#000';
            endScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            logoButton.classList.remove('inactive');
            logoButton.classList.remove('initial-animation');
            startGame();
        }
        
        function startGame() {
            gameState.isGameActive = true;
            gameState.player1SpeedRound = Math.ceil(Math.random() * (gameState.totalRounds / 2));
            gameState.player2SpeedRound = Math.ceil(Math.random() * (gameState.totalRounds / 2));
            console.log(`P1 Speed Round: ${gameState.player1SpeedRound}, P2 Speed Round: ${gameState.player2SpeedRound}`);

            logoButton.classList.add('bounce-animation');
            logoButton.classList.add('inactive');
            
            setTimeout(() => {
                logoButton.classList.remove('bounce-animation');
                document.body.style.backgroundColor = 'var(--player1-color)';
                showDiceScreen();
            }, 500);
        }
        
        function showDiceScreen() {
            // Verstecke alles andere
            logoButton.classList.add('hidden');
            genreScreen.classList.add('hidden');
            revealScreen.classList.add('hidden');
            revealBtn.classList.add('hidden');

            // Zeige Würfel-Animation
            diceScreen.classList.remove('hidden');
            diceAnimation.classList.remove('hidden');
            diceButtons.classList.add('hidden');
            
            // Re-trigger GIF animation
            const diceSrc = diceAnimation.src;
            diceAnimation.src = '';
            diceAnimation.src = diceSrc;

            setTimeout(() => {
                diceAnimation.classList.add('hidden');
                diceButtons.classList.remove('hidden');
            }, 4000);
        }
        
        function handleDiceChoice(e) {
            const target = e.target.closest('.dice-btn');
            if (!target) return;
            
            target.classList.add('bounce-animation');
            
            roundState.diceValue = parseInt(target.dataset.value, 10);
            roundState.attemptsMade = 0;

            if (roundState.diceValue === 7) {
                roundState.songDuration = 2000; // 2 Sekunden
                roundState.maxAttempts = 7;
            } else {
                roundState.songDuration = 7000; // 7 Sekunden
                roundState.maxAttempts = roundState.diceValue;
            }
            
            setTimeout(() => {
                target.classList.remove('bounce-animation');
                diceScreen.classList.add('hidden');
                showGenreScreen();
            }, 500);
        }
        
        function showGenreScreen() {
            genreScreen.classList.remove('hidden');
            genreButtons.forEach(btn => {
                btn.classList.remove('inactive', 'selected', 'blinking');
            });

            if (roundState.diceValue === 7) {
                // Spieler wählt selbst
            } else {
                // Zufällige Auswahl
                genreButtons.forEach(btn => btn.classList.add('blinking'));
                setTimeout(() => {
                    genreButtons.forEach(btn => btn.classList.remove('blinking'));
                    const randomIndex = Math.floor(Math.random() * genreButtons.length);
                    genreButtons.forEach((btn, index) => {
                        if (index !== randomIndex) {
                            btn.classList.add('inactive');
                        } else {
                            btn.classList.add('selected');
                        }
                    });
                }, 4000);
            }
        }
        
        function handleGenreChoice(e) {
            const target = e.target;
            if (!target.matches('.genre-btn') || target.classList.contains('inactive')) return;
            
            // Wenn eine Auswahl getroffen werden musste (nicht Würfel 7)
            if (roundState.diceValue !== 7 && !target.classList.contains('selected')) return;
            
            roundState.selectedGenre = target.dataset.genre;
            target.classList.add('bounce-animation');
            
            setTimeout(() => {
                genreScreen.classList.add('hidden');
                startRatingPhase();
            }, 500);
        }
        
        async function startRatingPhase() {
            // Prüfen, ob es eine Speed-Round ist
            const currentPlayerRound = Math.ceil(gameState.currentRound / 2);
            const isSpeedRound = (gameState.currentPlayer === 1 && currentPlayerRound === gameState.player1SpeedRound) ||
                                 (gameState.currentPlayer === 2 && currentPlayerRound === gameState.player2SpeedRound);

            if (isSpeedRound) {
                await showSpecialMessage("Speed-Round", 4000);
                startSpeedRoundCountdown();
            }
            
            prepareSong();
        }
        
        function showSpecialMessage(text, duration) {
            return new Promise(resolve => {
                specialMessageContainer.textContent = text;
                specialMessageContainer.style.animation = 'special-message-animation 1s forwards';
                setTimeout(() => {
                    specialMessageContainer.style.animation = 'fade-out 1s forwards';
                    setTimeout(() => {
                        specialMessageContainer.textContent = '';
                        specialMessageContainer.style.opacity = 0; // Reset for next use
                        resolve();
                    }, 1000);
                }, duration - 1000);
            });
        }
        
        function startSpeedRoundCountdown() {
            let count = 10;
            specialMessageContainer.style.animation = ''; // Clear previous animation
            
            const updateCountdown = () => {
                specialMessageContainer.textContent = count;
                specialMessageContainer.style.opacity = 1;
                specialMessageContainer.style.animation = 'pulse 1s';
                
                setTimeout(() => {
                     specialMessageContainer.style.animation = '';
                }, 950);

                count--;

                if (count < 0) {
                    clearInterval(roundState.speedRoundTimer);
                    specialMessageContainer.textContent = '';
                    revealRound(true); // true = force reveal
                }
            };
            
            updateCountdown();
            roundState.speedRoundTimer = setInterval(updateCountdown, 1000);
        }
        
        async function prepareSong() {
            logoButton.classList.remove('hidden');
            logoButton.classList.add('inactive'); // Inaktiv, bis Song geladen ist
            
            try {
                const playlistId = playlists[roundState.selectedGenre][Math.floor(Math.random() * 2)];
                const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                const items = data.items.filter(item => item.track && item.track.preview_url); // Filter für Tracks mit Preview
                const randomTrack = items[Math.floor(Math.random() * items.length)].track;
                roundState.currentTrack = randomTrack;
                
                logoButton.classList.remove('inactive'); // Jetzt klickbar
            } catch (error) {
                console.error("Error preparing song:", error);
                // Hier könnte man eine Fehlermeldung anzeigen und die Runde neu starten
            }
        }
        
        function playSongSnippet() {
            if (!deviceId || !roundState.currentTrack || roundState.attemptsMade >= roundState.maxAttempts) return;
            
            roundState.attemptsMade++;
            logoButton.classList.add('inactive', 'playing');
            
            const trackDurationMs = roundState.currentTrack.duration_ms;
            // Starte nicht zu nah am Ende
            const randomPosition = Math.floor(Math.random() * (trackDurationMs - roundState.songDuration - 5000));
            
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    uris: [roundState.currentTrack.uri],
                    position_ms: randomPosition
                })
            });
            
            // Zeige Auflösen-Button nach dem ersten Hören
            if (roundState.attemptsMade === 1) {
                revealBtn.classList.remove('hidden');
            }

            setTimeout(() => {
                spotifyPlayer.pause();
                logoButton.classList.remove('playing');
                if (roundState.attemptsMade < roundState.maxAttempts) {
                    logoButton.classList.remove('inactive');
                }
            }, roundState.songDuration);
        }
        
        function revealRound(isForced = false) {
             if (roundState.speedRoundTimer) {
                clearInterval(roundState.speedRoundTimer);
                specialMessageContainer.textContent = '';
            }
            
            spotifyPlayer.pause();
            logoButton.classList.add('inactive', 'hidden');
            revealBtn.classList.add('hidden');
            
            const track = roundState.currentTrack;
            document.getElementById('album-cover').src = track.album.images[0].url;
            document.getElementById('song-title').textContent = track.name;
            document.getElementById('song-artist').textContent = track.artists.map(a => a.name).join(', ');
            
            revealScreen.classList.remove('hidden');
        }
        
        function calculatePoints() {
            const points = roundState.diceValue - (roundState.attemptsMade - 1);
            return Math.max(1, points); // Mindestens 1 Punkt
        }
        
        function handleJudgement(isCorrect) {
            if (isCorrect) {
                const points = calculatePoints();
                if (gameState.currentPlayer === 1) {
                    gameState.player1Score += points;
                } else {
                    gameState.player2Score += points;
                }
            }
            
            gameState.currentRound++;
            
            if (gameState.currentRound > gameState.totalRounds) {
                showEndScreen();
            } else {
                // Spielerwechsel
                gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
                const nextPlayerColor = gameState.currentPlayer === 1 ? 'var(--player1-color)' : 'var(--player2-color)';
                document.body.style.backgroundColor = nextPlayerColor;
                
                revealScreen.classList.add('hidden');
                showDiceScreen();
            }
        }
        
        function showEndScreen() {
            gameContainer.classList.add('hidden');
            endScreen.classList.remove('hidden');
            document.body.style.backgroundColor = '#000'; // Reset für Gradient
            
            document.getElementById('player1-final-score').textContent = gameState.player1Score;
            document.getElementById('player2-final-score').textContent = gameState.player2Score;
            
            setTimeout(() => {
                resetGame();
            }, 7000);
        }


        // --- EVENT LISTENERS ---
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('code')) {
                fetchAccessToken(params.get('code'));
            }
            checkOrientation();
        });

        loginButton.addEventListener('click', redirectToSpotifyAuth);
        
        window.addEventListener('resize', checkOrientation);
        fullscreenOverlay.addEventListener('click', enterFullscreen);
        document.addEventListener('fullscreenchange', handleFullscreenChange);

        logoButton.addEventListener('click', () => {
            if (!gameState.isGameActive) {
                startGame();
            } else {
                playSongSnippet();
            }
        });
        
        diceButtons.addEventListener('click', handleDiceChoice);
        genreScreen.addEventListener('click', handleGenreChoice);
        revealBtn.addEventListener('click', () => revealRound(false));
        correctBtn.addEventListener('click', () => handleJudgement(true));
        wrongBtn.addEventListener('click', () => handleJudgement(false));

    </script>
</body>
</html>
