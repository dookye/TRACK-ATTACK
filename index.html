<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Musikraten mit Spotify</title>
<style>
  body {
    background: #111;
    color: #fff;
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  h1 {
    margin-top: 1rem;
  }
  button {
    background-color: #1DB954;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 1.25rem;
    margin: 0.5rem;
    padding: 1rem 2rem;
    min-width: 180px;
  }
  button:hover {
    background-color: #1ed760;
  }
  #loginSection, #genreSection, #modeSection, #startSection, #resultSection {
    margin-top: 1rem;
  }
  #infoText {
    margin: 1rem;
  }
</style>
</head>
<body>

<h1>Musikraten</h1>

<div id="infoText">Bitte logge dich zuerst mit deinem Spotify Premium-Account ein.</div>

<div id="loginSection">
  <button id="loginBtn">Spotify Login</button>
</div>

<div id="genreSection" style="display:none;">
  <h2>Genre wählen</h2>
  <button class="genreBtn" data-genre="punk">Punk Rock (90's & 00's)</button>
  <button class="genreBtn" data-genre="pop">Pop (2015–Heute)</button>
  <button class="genreBtn" data-genre="greatest">Greatest Hits</button>
</div>

<div id="modeSection" style="display:none;">
  <h2>Spielmodus wählen</h2>
  <button class="modeBtn" data-mode="normal">Normal (30 Sek.)</button>
  <button class="modeBtn" data-mode="profi">Profi (10 Sek.)</button>
  <button class="modeBtn" data-mode="crack">Crack (2 Sek.)</button>
</div>

<div id="startSection" style="display:none;">
  <button id="startGameBtn">START SPIEL</button>
  <button id="repeatBtn" style="display:none;">NOCHMAL HÖREN</button>
  <button id="revealBtn" style="display:none;">AUFLÖSEN</button>
</div>

<div id="resultSection" style="display:none;">
  <div id="songInfo"></div>
  <button id="correctBtn">RICHTIG</button>
  <button id="wrongBtn">FALSCH</button>
  <div id="scoreInfo"></div>
</div>

<script>
const clientId = '53257f6a1c144d3f929a60d691a0c6f6'; // Deine Spotify Client ID
const redirectUri = 'https://dookye.github.io/musik-raten/'; // Deine Redirect URI
let accessToken = null;
let refreshToken = null;

const playlists = {
  punk: [
    '39sVxPTg7BKwrf2MfgrtcD',
    // TODO: Hier weitere Playlist-IDs für Punk ergänzen
  ],
  pop: [
    '6mtYuOxzl58vSGnEDtZ9uB',
    // TODO: Hier weitere Playlist-IDs für Pop ergänzen
  ],
  greatest: [
    '2si7ChS6Y0hPBt4FsobXpg',
    // TODO: Hier weitere Playlist-IDs für Greatest Hits ergänzen
  ]
};

let selectedGenre = null;
let selectedMode = null;
let tracks = [];
let currentTrack = null;
let repeatCount = 0;
let score = 0;
let maxRepeats = 4;
let gameRound = 0;
const totalRounds = 10;
let pointsPerTry = 5;

const infoText = document.getElementById('infoText');
const loginSection = document.getElementById('loginSection');
const genreSection = document.getElementById('genreSection');
const modeSection = document.getElementById('modeSection');
const startSection = document.getElementById('startSection');
const resultSection = document.getElementById('resultSection');

const loginBtn = document.getElementById('loginBtn');
const startGameBtn = document.getElementById('startGameBtn');
const repeatBtn = document.getElementById('repeatBtn');
const revealBtn = document.getElementById('revealBtn');
const correctBtn = document.getElementById('correctBtn');
const wrongBtn = document.getElementById('wrongBtn');

const songInfo = document.getElementById('songInfo');
const scoreInfo = document.getElementById('scoreInfo');

////////////////////////////////////////////////////////
// --- PKCE HELPER FUNKTIONEN ---
// Generiert zufällige Strings und SHA256 Hash
function generateRandomString(length) {
  let text = '';
  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  for (let i = 0; i < length; i++) {
    text += possible.charAt(Math.floor(Math.random() * possible.length));
  }
  return text;
}

async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return btoa(String.fromCharCode(...hashArray))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
}

async function redirectToSpotifyAuth() {
  const codeVerifier = generateRandomString(64);
  const codeChallenge = await sha256(codeVerifier);

  localStorage.setItem('code_verifier', codeVerifier);

  const scope = 'user-read-playback-state user-modify-playback-state streaming';

  const args = new URLSearchParams({
    response_type: 'code',
    client_id: clientId,
    scope: scope,
    redirect_uri: redirectUri,
    code_challenge_method: 'S256',
    code_challenge: codeChallenge
  });

  window.location = 'https://accounts.spotify.com/authorize?' + args.toString();
}

async function fetchAccessToken(code) {
  const codeVerifier = localStorage.getItem('code_verifier');
  const body = new URLSearchParams({
    grant_type: 'authorization_code',
    code: code,
    redirect_uri: redirectUri,
    client_id: clientId,
    code_verifier: codeVerifier
  });

  const response = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body.toString()
  });

  const data = await response.json();
  accessToken = data.access_token;
  localStorage.setItem('access_token', accessToken);
  // Optional: refreshToken = data.refresh_token; falls gebraucht
}

////////////////////////////////////////////////////////
// --- Spotify Web Playback SDK Setup ---

// Player-Variable global (für Steuerung)
let player = null;
let deviceId = null;

window.onSpotifyWebPlaybackSDKReady = () => {
  if (!accessToken) return;
  player = new Spotify.Player({
    name: 'Musikraten Player',
    getOAuthToken: cb => { cb(accessToken); },
    volume: 0.5
  });

  player.addListener('ready', ({ device_id }) => {
    deviceId = device_id;
    console.log('Ready with Device ID', device_id);
  });

  player.addListener('not_ready', ({ device_id }) => {
    console.log('Device ID has gone offline', device_id);
  });

  player.addListener('player_state_changed', state => {
    // Hier kann man Playback-Status überwachen, z.B. Trackwechsel etc.
  });

  player.connect();
};

////////////////////////////////////////////////////////
// --- Ablauf nach Seiten-Load ---

async function handleRedirect() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('code')) {
    const code = params.get('code');
    await fetchAccessToken(code);
    history.replaceState(null, '', redirectUri);
    return true;
  }
  return false;
}

async function checkAccessToken() {
  accessToken = localStorage.getItem('access_token');
  if (!accessToken) return false;

  // Optional: hier kann man prüfen, ob token noch gültig ist (Spotify API call)
  return true;
}

////////////////////////////////////////////////////////
// --- Spiel-Logik Funktionen ---

async function getPlaylistTracksForGenre(genre) {
  // Hole alle Tracks aus allen Playlists eines Genres
  let allTracks = [];
  for (const playlistId of playlists[genre]) {
    const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const data = await response.json();
    if(data.items) {
      allTracks = allTracks.concat(data.items.map(item => item.track));
    }
  }
  return allTracks.filter(t => t != null);
}

async function playRandomTrack() {
  if (!deviceId) {
    alert('Bitte öffne die Spotify App und starte einmal die Wiedergabe, damit ein Wiedergabegerät aktiviert wird.');
    return;
  }
  if (!tracks.length) {
    alert('Keine Tracks geladen.');
    return;
  }
  repeatCount = 0;
  currentTrack = tracks[Math.floor(Math.random() * tracks.length)];
  gameRound++;

  // Zufällige Startzeit berechnen (in ms)
  const durationMs = currentTrack.duration_ms;
  let startMs = 0;
  if (durationMs > (selectedMode === 'normal' ? 30000 : selectedMode === 'profi' ? 10000 : 2000)) {
    startMs = Math.floor(Math.random() * (durationMs - (selectedMode === 'normal' ? 30000 : selectedMode === 'profi' ? 10000 : 2000)));
  }

  await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
    method: 'PUT',
    body: JSON.stringify({
      uris: [currentTrack.uri],
      position_ms: startMs
    }),
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${accessToken}`
    }
  });

  infoText.textContent = `Runde ${gameRound} von ${totalRounds}: Errate den Song!`;
  startGameBtn.style.display = 'none';
  repeatBtn.style.display = 'inline-block';
  revealBtn.style.display = 'inline-block';
  resultSection.style.display = 'none';
  songInfo.textContent = '';
}

async function repeatCurrentTrack() {
  if (repeatCount >= maxRepeats) {
    alert('Maximale Wiederholungen erreicht.');
    return;
  }
  repeatCount++;
  pointsPerTry = Math.max(5 - repeatCount, 1);

  const durationMs = currentTrack.duration_ms;
  let startMs = 0;
  if (durationMs > (selectedMode === 'normal' ? 30000 : selectedMode === 'profi' ? 10000 : 2000)) {
    startMs = Math.floor(Math.random() * (durationMs - (selectedMode === 'normal' ? 30000 : selectedMode === 'profi' ? 10000 : 2000)));
  }

  await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
    method: 'PUT',
    body: JSON.stringify({
      uris: [currentTrack.uri],
      position_ms: startMs
    }),
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${accessToken}`
    }
  });
}

function revealAnswer() {
  songInfo.innerHTML = `<strong>${currentTrack.name}</strong> von <em>${currentTrack.artists.map(a => a.name).join(', ')}</em>`;
  resultSection.style.display = 'block';
  startSection.style.display = 'none';
  repeatBtn.style.display = 'none';
  revealBtn.style.display = 'none';
}

function handleAnswer(isCorrect) {
  if (isCorrect) {
    score += pointsPerTry;
    scoreInfo.textContent = `Punktestand: ${score}`;
  }

  if (gameRound >= totalRounds) {
    alert(`Spiel vorbei! Deine Punktzahl: ${score} von maximal ${totalRounds*5}`);
    resetGame();
  } else {
    startSection.style.display = 'block';
    startGameBtn.style.display = 'inline-block';
    resultSection.style.display = 'none';
    infoText.textContent = 'Wähle dein Genre und Spielmodus oder starte eine neue Runde.';
  }
}

function resetGame() {
  score = 0;
  gameRound = 0;
  pointsPerTry = 5;
  startSection.style.display = 'none';
  genreSection.style.display = 'none';
  modeSection.style.display = 'none';
  loginSection.style.display = 'block';
  infoText.textContent = 'Bitte logge dich zuerst mit deinem Spotify Premium-Account ein.';
}

////////////////////////////////////////////////////////
// --- Event Listeners ---

loginBtn.addEventListener('click', () => {
  redirectToSpotifyAuth();
});

document.querySelectorAll('.genreBtn').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    selectedGenre = e.target.dataset.genre;
    infoText.textContent = `Genre "${selectedGenre}" ausgewählt. Bitte wähle nun den Spielmodus.`;
    modeSection.style.display = 'block';
  });
});

document.querySelectorAll('.modeBtn').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    selectedMode = e.target.dataset.mode;
    infoText.textContent = `Spielmodus "${selectedMode}" ausgewählt. Lade Songs...`;
    startSection.style.display = 'block';

    // Tracks laden
    tracks = await getPlaylistTracksForGenre(selectedGenre);
    if(tracks.length === 0) {
      alert('Keine Tracks für das gewählte Genre gefunden!');
      return;
    }
    infoText.textContent = `Songs geladen. Klicke auf START SPIEL, um zu beginnen.`;
  });
});

startGameBtn.addEventListener('click', async () => {
  if (!deviceId) {
    alert('Bitte öffne deine Spotify App und starte einmal die Wiedergabe, damit der Player aktiv wird.');
    return;
  }
  if (!selectedGenre || !selectedMode) {
    alert('Bitte Genre und Spielmodus wählen.');
    return;
  }
  await playRandomTrack();
});

repeatBtn.addEventListener('click', async () => {
  await repeatCurrentTrack();
});

revealBtn.addEventListener('click', () => {
  revealAnswer();
});

correctBtn.addEventListener('click', () => {
  handleAnswer(true);
});

wrongBtn.addEventListener('click', () => {
  handleAnswer(false);
});

////////////////////////////////////////////////////////
// --- Initialisierung nach Laden der Seite ---

(async () => {
  const codeFromUrl = await handleRedirect();
  const tokenExists = await checkAccessToken();

  if (codeFromUrl || tokenExists) {
    loginSection.style.display = 'none';
    genreSection.style.display = 'block';

    // SDK laden
    const script = document.createElement('script');
    script.src = 'https://sdk.scdn.co/spotify-player.js';
    document.head.appendChild(script);
  }
})();
</script>

</body>
</html>
