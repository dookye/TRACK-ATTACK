<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Musikratespiel â€žTrack Attackâ€œ (PKCE)</title>
<style>
  body {
    background-color: #191414;
    color: #fff;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 2rem;
  }
  h1, h2 {
    margin-bottom: 1rem;
  }
  button {
    background-color: #1DB954;
    border: none;
    border-radius: 30px;
    color: white;
    font-size: 1.2rem;
    margin: 0.5rem;
    padding: 1rem 2rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #1ed760;
  }
  .hidden {
    display: none;
  }
  #info {
    margin-top: 2rem;
    min-height: 3rem;
    font-weight: bold;
  }
  #scoreboard {
    margin-top: 1rem;
  }
</style>
</head>
<body>

<h1>ðŸŽ§ Track Attack</h1>
<div id="loginContainer">
  <button id="loginBtn">Bei Spotify einloggen</button>
</div>

<div id="genreContainer" class="hidden">
  <h2>WÃ¤hle ein Genre</h2>
  <button data-genre="punk">Punk Rock (90s & 00s)</button>
  <button data-genre="pop">Pop Hits (2015â€“2025)</button>
  <button data-genre="hits">Die grÃ¶ÃŸten Hits aller Zeiten</button>
</div>

<div id="modeContainer" class="hidden">
  <h2>WÃ¤hle einen Spielmodus</h2>
  <button data-mode="normal">Normal (30 Sek.)</button>
  <button data-mode="profi">Profi (10 Sek.)</button>
  <button data-mode="crack">Crack (2 Sek.)</button>
</div>

<div id="startContainer" class="hidden">
  <button id="startBtn">Track Attack Starten</button>
</div>

<div id="controlContainer" class="hidden" style="margin-top: 1rem;">
  <button id="repeatBtn">NOCHMAL HÃ–REN</button>
  <button id="revealBtn">AUFLÃ–SEN</button>
</div>

<div id="answerContainer" class="hidden" style="margin-top: 1rem;">
  <button id="correctBtn">RICHTIG</button>
  <button id="wrongBtn">FALSCH</button>
</div>

<div id="info"></div>
<div id="scoreboard">Punkte: <span id="score">0</span> | Runde: <span id="round">0</span> / 10</div>

<script>
const clientId = '53257f6a1c144d3f929a60d691a0c6f6';
const redirectUri = 'https://dookye.github.io/musik-raten/';
const scopes = [
  'streaming',
  'user-read-email',
  'user-read-private',
  'user-read-playback-state',
  'user-modify-playback-state',
].join(' ');

// Playlist-IDs pro Genre (hier kannst du weitere einfÃ¼gen)
const playlistsByGenre = {
  punk: [
    '39sVxPTg7BKwrf2MfgrtcD', // Punk Rock 90 & 00
    // weitere Playlists hier als Strings, z.B. 'PL12345',
  ],
  pop: [
    '6mtYuOxzl58vSGnEDtZ9uB', // Pop Hits 2000â€“2025
    // weitere Pop Playlists hier
  ],
  hits: [
    '2si7ChS6Y0hPBt4FsobXpg', // GrÃ¶ÃŸte Hits
    // weitere Hits-Playlists hier
  ]
};

const modeTimes = {
  normal: 30,
  profi: 10,
  crack: 2,
};

let accessToken = null;
let refreshToken = null;
let expiresAt = 0;

let selectedGenre = null;
let selectedMode = null;
let currentPlaylistIds = [];
let currentSong = null;
let playbackDeviceId = null;

let round = 0;
let score = 0;
let triesForCurrentSong = 0;
let maxRounds = 10;

let currentSpotifyApiSongUri = null;
let currentTrackName = '';
let currentTrackArtist = '';

/**
 * --- PKCE Funktionen ---
 */

function base64urlencode(buffer) {
  return btoa(String.fromCharCode(...new Uint8Array(buffer)))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  return await crypto.subtle.digest('SHA-256', data);
}

function generateRandomString(length) {
  const array = new Uint8Array(length);
  crypto.getRandomValues(array);
  return Array.from(array, dec => ('0' + dec.toString(16)).slice(-2)).join('');
}

async function generateCodeChallenge(codeVerifier) {
  const hashed = await sha256(codeVerifier);
  return base64urlencode(hashed);
}

/**
 * --- AUTH ---
 */

async function startAuth() {
  const codeVerifier = generateRandomString(64);
  localStorage.setItem('code_verifier', codeVerifier);
  const codeChallenge = await generateCodeChallenge(codeVerifier);

  const authUrl = new URL('https://accounts.spotify.com/authorize');
  authUrl.searchParams.set('response_type', 'code');
  authUrl.searchParams.set('client_id', clientId);
  authUrl.searchParams.set('scope', scopes);
  authUrl.searchParams.set('redirect_uri', redirectUri);
  authUrl.searchParams.set('code_challenge_method', 'S256');
  authUrl.searchParams.set('code_challenge', codeChallenge);
  authUrl.searchParams.set('show_dialog', 'true');

  window.location = authUrl.toString();
}

async function fetchAccessToken(code) {
  const codeVerifier = localStorage.getItem('code_verifier');
  if (!codeVerifier) {
    alert('Code verifier fehlt!');
    return;
  }

  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: 'authorization_code',
    code: code,
    redirect_uri: redirectUri,
    code_verifier: codeVerifier,
  });

  try {
    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: body.toString()
    });
    const data = await response.json();

    if (data.access_token) {
      accessToken = data.access_token;
      refreshToken = data.refresh_token;
      expiresAt = Date.now() + data.expires_in * 1000;
      localStorage.setItem('access_token', accessToken);
      localStorage.setItem('refresh_token', refreshToken);
      localStorage.setItem('expires_at', expiresAt);
      // Sauber URL ohne ?code= etc.
      window.history.replaceState({}, document.title, redirectUri);
      onLoginSuccess();
    } else {
      alert('Fehler beim Token holen: ' + JSON.stringify(data));
    }
  } catch (err) {
    alert('Fehler beim Token holen: ' + err);
  }
}

async function refreshAccessToken() {
  const storedRefreshToken = localStorage.getItem('refresh_token');
  if (!storedRefreshToken) {
    logout();
    return;
  }

  const body = new URLSearchParams({
    grant_type: 'refresh_token',
    refresh_token: storedRefreshToken,
    client_id: clientId,
  });

  try {
    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body.toString()
    });
    const data = await response.json();
    if (data.access_token) {
      accessToken = data.access_token;
      expiresAt = Date.now() + data.expires_in * 1000;
      localStorage.setItem('access_token', accessToken);
      localStorage.setItem('expires_at', expiresAt);
    } else {
      logout();
    }
  } catch {
    logout();
  }
}

function logout() {
  localStorage.removeItem('access_token');
  localStorage.removeItem('refresh_token');
  localStorage.removeItem('expires_at');
  localStorage.removeItem('code_verifier');
  accessToken = null;
  refreshToken = null;
  expiresAt = 0;
  location.reload();
}

/**
 * --- UI & Flow ---
 */

function show(elementId) {
  document.getElementById(elementId).classList.remove('hidden');
}

function hide(elementId) {
  document.getElementById(elementId).classList.add('hidden');
}

function setInfo(text) {
  document.getElementById('info').textContent = text;
}

function updateScoreboard() {
  document.getElementById('score').textContent = score;
  document.getElementById('round').textContent = round;
}

function onLoginSuccess() {
  hide('loginContainer');
  show('genreContainer');
  setInfo('Spotify Login erfolgreich! WÃ¤hle dein Genre.');
}

async function checkLogin() {
  // PrÃ¼fen ob Access Token noch gÃ¼ltig ist
  accessToken = localStorage.getItem('access_token');
  refreshToken = localStorage.getItem('refresh_token');
  expiresAt = localStorage.getItem('expires_at') || 0;

  if (!accessToken) {
    return false;
  }
  if (Date.now() > expiresAt) {
    // Token refreshen
    await refreshAccessToken();
  }
  if (accessToken) {
    onLoginSuccess();
    return true;
  }
  return false;
}

/**
 * --- Spotify API Helfer ---
 */

async function getUserDevices() {
  const res = await fetch('https://api.spotify.com/v1/me/player/devices', {
    headers: { Authorization: 'Bearer ' + accessToken }
  });
  const data = await res.json();
  return data.devices || [];
}

async function startPlayback(uri, positionMs = 0) {
  if (!playbackDeviceId) {
    const devices = await getUserDevices();
    if (devices.length === 0) {
      alert('Bitte starte Spotify auf einem deiner GerÃ¤te und lade diese Seite neu.');
      return false;
    }
    playbackDeviceId = devices[0].id;
  }
  const body = {
    uris: [uri],
    position_ms: positionMs
  };
  const res = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${playbackDeviceId}`, {
    method: 'PUT',
    headers: {
      Authorization: 'Bearer ' + accessToken,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  return res.ok;
}

async function getPlaylistTracks(playlistId) {
  let tracks = [];
  let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;
  while (url) {
    const res = await fetch(url, {
      headers: { Authorization: 'Bearer ' + accessToken }
    });
    const data = await res.json();
    tracks = tracks.concat(data.items);
    url = data.next;
  }
  return tracks;
}

async function pickRandomTrackFromPlaylists(playlistIds) {
  // WÃ¤hle zufÃ¤llige Playlist aus
  const playlistId = playlistIds[Math.floor(Math.random() * playlistIds.length)];
  const tracks = await getPlaylistTracks(playlistId);
  if (tracks.length === 0) return null;

  // WÃ¤hle zufÃ¤lligen Track mit Preview oder Spotify URI (Preview URL wird von API geliefert, aber zur Wiedergabe brauchen wir Spotify URI)
  // Wir nehmen einfach Spotify URI

  const trackItems = tracks.filter(item => item.track && item.track.uri && item.track.duration_ms);
  if (trackItems.length === 0
