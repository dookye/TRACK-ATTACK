<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRACK ATTACK233</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Globale Stile und Zurücksetzen der Touch-Highlight-Farbe */
        body {
            font-family: 'Inter', sans-serif;
            background-color: black;
            color: white;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Verhindert Scrollen */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.8s ease-in-out; /* Für Hintergrundfarbwechsel */
            -webkit-tap-highlight-color: transparent; /* Für Webkit-Browser (iOS, Android Chrome) */
            -webkit-touch-callout: none; /* Deaktiviert das Kontextmenü bei langem Drücken auf iOS */
            -webkit-user-select: none; /* Verhindert Textauswahl */
            -moz-user-select: none; /* Für Firefox */
            -ms-user-select: none; /* Für Internet Explorer/Edge */
            user-select: none; /* Standard für andere Browser */
            outline: none !important; /* Entfernt den Fokus-Outline */
        }

        /* Spezifische Stile für klickbare Elemente */
        button, a, .clickable {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            outline: none !important;
        }

        /* Overlay für Geräteausrichtung */
        #orientation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            text-align: center;
            z-index: 1000;
            display: none; /* Standardmäßig ausgeblendet */
        }

        /* Overlay für Vollbildmodus */
        #fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            text-align: center;
            z-index: 999;
            display: none; /* Standardmäßig ausgeblendet */
        }

        /* Bounce-Animation für Buttons */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-15px);
            }
            60% {
                transform: translateY(-7px);
            }
        }

        .bounce-animation {
            animation: bounce 0.6s ease-in-out;
        }

        /* Blur-Effekt für inaktive Buttons */
        .blurred {
            filter: blur(5px);
            pointer-events: none;
        }

        /* Speed-Round Animation */
        @keyframes speedRoundZoom {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
            100% {
                opacity: 0;
                transform: scale(1);
            }
        }

        .speed-round-animation {
            animation: speedRoundZoom 4s ease-out forwards;
        }

        /* Countdown Stile */
        #countdown-display {
            font-size: 8rem;
            font-weight: bold;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            display: none;
        }

        /* Player Score Display */
        #score-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            height: 100%;
            font-size: 6rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        #player1-score-display, #player2-score-display {
            flex: 1;
            text-align: center;
        }

        /* Genre Button Styles */
        .genre-button {
            background-color: black;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            border: 3px solid transparent; /* Initial transparent border */
            background-image: linear-gradient(to right, #00f, #f0f, #fff); /* Gradient for the border */
            background-origin: border-box;
            background-clip: content-box, border-box;
            transition: transform 0.1s ease-in-out, filter 0.3s ease-in-out;
        }

        .genre-button:hover {
            transform: scale(1.05);
        }

        .genre-button.inactive {
            filter: grayscale(100%) brightness(50%);
            pointer-events: none;
            opacity: 0.7;
        }

        /* Song Info Display */
        #song-info-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: 2rem;
        }

        #song-cover {
            width: 200px;
            height: 200px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        #song-details {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* AUFLÖSEN, RICHTIG, FALSCH Button Styles */
        .action-button {
            background-color: black;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            border: 3px solid transparent;
            background-image: linear-gradient(to right, #00f, #f0f, #fff);
            background-origin: border-box;
            background-clip: content-box, border-box;
            transition: transform 0.1s ease-in-out;
        }

        .action-button:hover {
            transform: scale(1.05);
        }

        .action-button.disabled {
            filter: grayscale(100%) brightness(50%);
            pointer-events: none;
            opacity: 0.7;
        }

    </style>
</head>
<body class="bg-black text-white flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Orientation Overlay -->
    <div id="orientation-overlay">
        <p>Bitte drehe dein Gerät ins Querformat.</p>
        <p>Please rotate your device to landscape mode.</p>
    </div>

    <!-- Fullscreen Overlay -->
    <div id="fullscreen-overlay" class="clickable">
        <p>Klicke, um in den Vollbildmodus zu wechseln.</p>
        <p>Click to Fullscreen</p>
    </div>

    <!-- Main Game Container -->
    <div id="game-container" class="flex flex-col items-center justify-center w-full h-full">

        <!-- Login Screen -->
        <div id="login-screen" class="flex flex-col items-center justify-center text-center">
            <p class="text-2xl mb-8">Please log in with your Spotify-Premium-Account</p>
            <button id="login-button" class="flex items-center bg-[#1DB954] text-white px-8 py-4 rounded-full text-xl font-bold hover:bg-[#1ed760] transition-colors shadow-lg">
                <img src="https://placehold.co/30x30/1DB954/FFFFFF?text=S" alt="Spotify Icon" class="w-8 h-8 mr-3">
                LOG IN
            </button>
        </div>

        <!-- Welcome Animation / Logo Button Screen -->
        <div id="start-screen" class="hidden flex-col items-center justify-center">
            <button id="logo-button" class="w-64 h-64 rounded-full overflow-hidden flex items-center justify-center bg-transparent border-none p-0 cursor-pointer">
                <img id="logo-image" src="https://placehold.co/256x256/000000/FFFFFF?text=LOGO" alt="Game Logo" class="w-full h-full object-contain">
            </button>
        </div>

        <!-- Dice Screen -->
        <div id="dice-screen" class="hidden flex-col items-center justify-center">
            <img id="dice-animation" src="https://placehold.co/300x300/000000/FFFFFF?text=DICE+ANIM" alt="Dice Animation" class="w-72 h-72 object-contain mb-8">
            <div id="dice-buttons" class="grid grid-cols-2 gap-4 hidden">
                <button class="w-32 h-32 flex items-center justify-center bg-transparent border-none p-0 cursor-pointer dice-button" data-dice-value="3">
                    <img src="https://placehold.co/128x128/000000/FFFFFF?text=W3" alt="Dice 3" class="w-full h-full object-contain">
                </button>
                <button class="w-32 h-32 flex items-center justify-center bg-transparent border-none p-0 cursor-pointer dice-button" data-dice-value="4">
                    <img src="https://placehold.co/128x128/000000/FFFFFF?text=W4" alt="Dice 4" class="w-full h-full object-contain">
                </button>
                <button class="w-32 h-32 flex items-center justify-center bg-transparent border-none p-0 cursor-pointer dice-button" data-dice-value="5">
                    <img src="https://placehold.co/128x128/000000/FFFFFF?text=W5" alt="Dice 5" class="w-full h-full object-contain">
                </button>
                <button class="w-32 h-32 flex items-center justify-center bg-transparent border-none p-0 cursor-pointer dice-button" data-dice-value="7">
                    <img src="https://placehold.co/128x128/000000/FFFFFF?text=W7" alt="Dice 7" class="w-full h-full object-contain">
                </button>
            </div>
        </div>

        <!-- Genre Screen -->
        <div id="genre-screen" class="hidden flex-col items-center justify-center w-full max-w-2xl">
            <h2 class="text-3xl mb-8">Wähle ein Genre</h2>
            <div id="genre-buttons-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                <button class="genre-button" data-genre-id="punk-rock">Punk Rock (90's & 00')</button>
                <button class="genre-button" data-genre-id="pop-hits">Pop Hits 2000-2025</button>
                <button class="genre-button" data-genre-id="greatest-hits">Die größten Hits aller Zeiten</button>
                <button class="genre-button" data-genre-id="disney-songs">Disney Songs</button>
            </div>
        </div>

        <!-- Guess Screen -->
        <div id="guess-screen" class="hidden flex-col items-center justify-center">
            <p id="current-player-text" class="text-xl mb-4"></p>
            <button id="play-button" class="w-48 h-48 rounded-full overflow-hidden flex items-center justify-center bg-transparent border-none p-0 cursor-pointer">
                <img id="play-button-image" src="https://placehold.co/192x192/000000/FFFFFF?text=PLAY" alt="Play Button" class="w-full h-full object-contain">
            </button>
            <p id="attempts-left-text" class="text-lg mt-4"></p>

            <button id="reveal-button" class="action-button mt-8 hidden">AUFLÖSEN</button>

            <div id="song-info-display" class="hidden">
                <img id="song-cover" src="" alt="Album Cover" class="w-48 h-48 rounded-lg shadow-lg">
                <div id="song-details" class="mt-4">
                    <p id="song-title" class="text-2xl font-bold"></p>
                    <p id="song-artist" class="text-xl"></p>
                </div>
                <div class="flex space-x-4 mt-8">
                    <button id="correct-button" class="action-button bg-green-600 hover:bg-green-700">RICHTIG</button>
                    <button id="wrong-button" class="action-button bg-red-600 hover:bg-red-700">FALSCH</button>
                </div>
            </div>
        </div>

        <!-- Speed Round Display -->
        <div id="speed-round-display" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white font-bold text-6xl text-center z-50">
            Speed-Round
        </div>

        <!-- Countdown Display -->
        <div id="countdown-display" class="hidden"></div>

        <!-- Score Screen -->
        <div id="score-screen" class="hidden flex-col items-center justify-center w-full h-full">
            <div id="score-display">
                <div id="player1-score-display">Spieler 1: 0</div>
                <div id="player2-score-display">Spieler 2: 0</div>
            </div>
        </div>

    </div>

    <!-- Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <script>
        // Spotify API Konfiguration
        const CLIENT_ID = '53257f6a1c144d3f929a60d691a0c6f6';
        const REDIRECT_URI = 'https://dookye.github.io/TRACK-ATTACK/';
        const SCOPES = 'streaming user-read-email user-read-private user-modify-playback-state';

        // UI Elemente
        const loginScreen = document.getElementById('login-screen');
        const loginButton = document.getElementById('login-button');
        const orientationOverlay = document.getElementById('orientation-overlay');
        const fullscreenOverlay = document.getElementById('fullscreen-overlay');
        const startScreen = document.getElementById('start-screen');
        const logoButton = document.getElementById('logo-button');
        const logoImage = document.getElementById('logo-image');
        const diceScreen = document.getElementById('dice-screen');
        const diceAnimation = document.getElementById('dice-animation');
        const diceButtonsContainer = document.getElementById('dice-buttons');
        const diceButtons = document.querySelectorAll('.dice-button');
        const genreScreen = document.getElementById('genre-screen');
        const genreButtonsContainer = document.getElementById('genre-buttons-container');
        const genreButtons = document.querySelectorAll('.genre-button');
        const guessScreen = document.getElementById('guess-screen');
        const playButton = document.getElementById('play-button');
        const playButtonImage = document.getElementById('play-button-image');
        const currentPlayerText = document.getElementById('current-player-text');
        const attemptsLeftText = document.getElementById('attempts-left-text');
        const revealButton = document.getElementById('reveal-button');
        const songInfoDisplay = document.getElementById('song-info-display');
        const songCover = document.getElementById('song-cover');
        const songTitle = document.getElementById('song-title');
        const songArtist = document.getElementById('song-artist');
        const correctButton = document.getElementById('correct-button');
        const wrongButton = document.getElementById('wrong-button');
        const speedRoundDisplay = document.getElementById('speed-round-display');
        const countdownDisplay = document.getElementById('countdown-display');
        const scoreScreen = document.getElementById('score-screen');
        const player1ScoreDisplay = document.getElementById('player1-score-display');
        const player2ScoreDisplay = document.getElementById('player2-score-display');

        // Spielzustand Variablen
        let accessToken = null;
        let refreshToken = null;
        let player = null; // Spotify Web Playback SDK Player
        let deviceId = null;

        let gameStarted = false;
        let welcomeAnimationShown = sessionStorage.getItem('welcomeAnimationShown') === 'true';

        let currentPlayer = 1; // 1 or 2
        let currentRound = 1; // Total rounds for both players combined
        const MAX_ROUNDS = 20; // 10 rounds per player

        let player1Score = 0;
        let player2Score = 0;

        let selectedDiceValue = 0;
        let gameDuration = 0; // in milliseconds
        let maxPoints = 0;
        let listenAttempts = 0;
        let attemptsMade = 0;

        let selectedGenreId = '';
        let currentTrack = null;
        let currentTrackDuration = 0; // in ms
        let currentTrackStartOffset = 0; // in ms

        let speedRoundsPlayer1 = [];
        let speedRoundsPlayer2 = [];
        let isSpeedRound = false;
        let countdownInterval = null;

        // Spotify Playlist IDs nach Genre
        const genrePlaylists = {
            'punk-rock': ['39sVxPTg7BKwrf2MfgrtcD', '7ITmaFa2rOhXAmKmUUCG9E'],
            'pop-hits': ['6mtYuOxzl58vSGnEDtZ9uB', '34NbomaTu7YuOYnky8nLXL'],
            'greatest-hits': ['2si7ChS6Y0hPBt4FsobXpg', '2y09fNnXHvoqc1WGHvbhkZ'],
            'disney-songs': ['3Bilb56eeS7db5f3DTEwMR', '2bhbwexk7c6yJrEB4CtuY8']
        };

        // --- Hilfsfunktionen ---

        // Generiert einen zufälligen String für PKCE
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let text = '';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        // Codiert den String für PKCE
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        // Konvertiert ArrayBuffer zu Base64-URL-sicherem String
        function base64urlencode(input) {
            return btoa(String.fromCharCode(...new Uint8Array(input)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        // Erzeugt den Code Challenge
        async function generateCodeChallenge(codeVerifier) {
            const hashed = await sha256(codeVerifier);
            return base64urlencode(hashed);
        }

        // Zeigt einen Screen an und blendet andere aus
        function showScreen(screenElement) {
            [loginScreen, startScreen, diceScreen, genreScreen, guessScreen, scoreScreen].forEach(screen => {
                if (screen === screenElement) {
                    screen.classList.remove('hidden');
                    screen.classList.add('flex');
                } else {
                    screen.classList.add('hidden');
                    screen.classList.remove('flex');
                }
            });
        }

        // Fügt Bounce-Animation zu einem Element hinzu
        function addBounceAnimation(element) {
            element.classList.remove('bounce-animation'); // Entfernt die Klasse, um die Animation zurückzusetzen
            void element.offsetWidth; // Trick, um Reflow zu erzwingen
            element.classList.add('bounce-animation');
        }

        // Berechnet Punkte basierend auf Würfelwert und Versuchen
        function calculatePoints(diceValue, attemptsMade) {
            const points = diceValue - (attemptsMade - 1);
            return Math.max(1, points); // Mindestpunktzahl ist 1
        }

        // Generiert zufällige Runden für Speed-Rounds
        function generateSpeedRounds() {
            speedRoundsPlayer1 = [];
            speedRoundsPlayer2 = [];
            while (speedRoundsPlayer1.length < 1) { // Eine Speed-Round pro Spieler
                const round = Math.floor(Math.random() * 10) + 1; // Runden 1-10
                if (!speedRoundsPlayer1.includes(round)) {
                    speedRoundsPlayer1.push(round);
                }
            }
            while (speedRoundsPlayer2.length < 1) {
                const round = Math.floor(Math.random() * 10) + 1;
                if (!speedRoundsPlayer2.includes(round)) {
                    speedRoundsPlayer2.push(round);
                }
            }
            console.log("Speed Rounds Player 1:", speedRoundsPlayer1);
            console.log("Speed Rounds Player 2:", speedRoundsPlayer2);
        }

        // --- Phase 1: Authentifizierung & Geräte-Einrichtung ---

        // Schritt 1.1: Erzwingen der Spotify-Anmeldung
        async function handleLogin() {
            const codeVerifier = generateRandomString(128);
            sessionStorage.setItem('code_verifier', codeVerifier);
            const codeChallenge = await generateCodeChallenge(codeVerifier);

            const authUrl = new URL('https://accounts.spotify.com/authorize');
            authUrl.searchParams.append('client_id', CLIENT_ID);
            authUrl.searchParams.append('response_type', 'code');
            authUrl.searchParams.append('redirect_uri', REDIRECT_URI);
            authUrl.searchParams.append('scope', SCOPES);
            authUrl.searchParams.append('code_challenge_method', 'S256');
            authUrl.searchParams.append('code_challenge', codeChallenge);

            window.location.href = authUrl.toString();
        }

        // Token-Austausch nach Callback
        async function exchangeCodeForTokens(code) {
            const codeVerifier = sessionStorage.getItem('code_verifier');
            if (!codeVerifier) {
                console.error('Code Verifier nicht gefunden.');
                return;
            }

            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: CLIENT_ID,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI,
                        code_verifier: codeVerifier,
                    }).toString(),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Fehler beim Token-Austausch:', errorData);
                    throw new Error('Token exchange failed');
                }

                const data = await response.json();
                accessToken = data.access_token;
                refreshToken = data.refresh_token;

                sessionStorage.setItem('access_token', accessToken);
                sessionStorage.setItem('refresh_token', refreshToken);
                sessionStorage.setItem('token_expires_in', Date.now() + data.expires_in * 1000); // Speichern des Ablaufzeitpunkts

                console.log('Access Token erhalten:', accessToken);
                console.log('Refresh Token erhalten:', refreshToken);

                // Initialisiere Spotify SDK nach erfolgreichem Login
                initializeSpotifySDK();
            } catch (error) {
                console.error('Fehler beim Token-Austausch:', error);
                // Zeige Login-Screen erneut, falls Fehler auftritt
                showScreen(loginScreen);
            }
        }

        // Schritt 1.2: Erzwingen der Geräteausrichtung
        function checkOrientation() {
            if (window.matchMedia('(orientation: portrait)').matches) {
                orientationOverlay.style.display = 'flex';
                // Wenn das Gerät ins Hochformat gedreht wird, sollte der Vollbild-Overlay nicht sichtbar sein
                fullscreenOverlay.style.display = 'none';
            } else {
                orientationOverlay.style.display = 'none';
                // Wenn im Querformat und noch nicht im Vollbild, zeige Fullscreen-Overlay
                if (gameStarted && !document.fullscreenElement) {
                    fullscreenOverlay.style.display = 'flex';
                }
            }
        }

        // Schritt 1.3: Erzwingen des Vollbild-Modus
        function requestFullscreen() {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.mozRequestFullScreen) { /* Firefox */
                document.documentElement.mozRequestFullScreen();
            } else if (document.documentElement.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) { /* IE/Edge */
                document.documentElement.msRequestFullscreen();
            }
        }

        function handleFullscreenChange() {
            if (!document.fullscreenElement && gameStarted) {
                // Wenn Vollbildmodus verlassen wird und das Spiel gestartet ist
                if (window.matchMedia('(orientation: landscape)').matches) {
                    fullscreenOverlay.style.display = 'flex';
                }
            } else if (document.fullscreenElement) {
                // Wenn Vollbildmodus aktiv ist
                fullscreenOverlay.style.display = 'none';
                if (!welcomeAnimationShown) {
                    playWelcomeAnimation();
                } else if (gameStarted) {
                    // Wenn Spiel bereits gestartet, einfach fortfahren (z.B. zum Startbildschirm)
                    showScreen(startScreen);
                    logoButton.classList.remove('blurred');
                }
            }
        }

        // Schritt 1.4: Einmalige Begrüßungsanimation
        function playWelcomeAnimation() {
            if (!welcomeAnimationShown) {
                addBounceAnimation(logoImage); // Logo-Bild animieren
                logoButton.classList.add('blurred'); // Logo-Button während Animation inaktiv
                setTimeout(() => {
                    logoButton.classList.remove('blurred'); // Logo-Button nach Animation aktiv
                    welcomeAnimationShown = true;
                    sessionStorage.setItem('welcomeAnimationShown', 'true');
                    gameStarted = true; // Spiel kann jetzt gestartet werden
                    showScreen(startScreen);
                }, 800); // Dauer der Bounce-Animation
            }
        }

        // --- Spotify Web Playback SDK Initialisierung ---
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log('Spotify Web Playback SDK ist bereit.');
            // Überprüfe, ob ein Access Token vorhanden ist, um den Player zu initialisieren
            accessToken = sessionStorage.getItem('access_token');
            if (accessToken) {
                initializeSpotifySDK();
            } else {
                // Wenn kein Token, zeige Login-Screen an
                showScreen(loginScreen);
            }
        };

        async function initializeSpotifySDK() {
            if (!accessToken) {
                console.error('Kein Access Token vorhanden, kann Spotify SDK nicht initialisieren.');
                showScreen(loginScreen);
                return;
            }

            player = new Spotify.Player({
                name: 'TRACK ATTACK Player',
                getOAuthToken: cb => { cb(accessToken); },
                volume: 0.5
            });

            // Ready
            player.addListener('ready', ({ device_id }) => {
                deviceId = device_id;
                console.log('Bereit mit Device ID', device_id);
                // Sobald der Player bereit ist, erzwinge die Ausrichtung und dann den Vollbildmodus
                checkOrientation(); // Überprüft die Ausrichtung und zeigt ggf. Overlay an
                if (!window.matchMedia('(orientation: portrait)').matches) {
                    // Wenn bereits im Querformat, zeige Fullscreen-Overlay
                    fullscreenOverlay.style.display = 'flex';
                }
            });

            // Not Ready
            player.addListener('not_ready', ({ device_id }) => {
                console.log('Gerät ist nicht bereit für die Wiedergabe', device_id);
            });

            // Player State Changed
            player.addListener('player_state_changed', state => {
                // console.log('Player State Changed:', state);
            });

            // Error handling
            player.addListener('initialization_error', ({ message }) => {
                console.error('Fehler bei der Initialisierung:', message);
                alert('Fehler bei der Spotify-Initialisierung. Bitte stelle sicher, dass du Spotify Premium hast und angemeldet bist.');
                showScreen(loginScreen);
            });

            player.addListener('authentication_error', ({ message }) => {
                console.error('Authentifizierungsfehler:', message);
                alert('Authentifizierungsfehler. Bitte melde dich erneut an.');
                sessionStorage.clear(); // Lösche Tokens
                showScreen(loginScreen);
            });

            player.addListener('account_error', ({ message }) => {
                console.error('Account-Fehler:', message);
                alert('Account-Fehler. Du benötigst einen Spotify Premium Account, um dieses Spiel zu spielen.');
                showScreen(loginScreen);
            });

            player.addListener('playback_error', ({ message }) => {
                console.error('Wiedergabefehler:', message);
                alert('Wiedergabefehler. Bitte überprüfe deine Spotify-App.');
            });

            // Verbinde den Player
            player.connect();

            // Übertrage die Wiedergabe auf das neue Gerät
            await transferPlaybackToDevice(deviceId);
        }

        async function transferPlaybackToDevice(targetDeviceId) {
            if (!accessToken) {
                console.error('Kein Access Token für die Wiedergabeübertragung.');
                return;
            }
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        device_ids: [targetDeviceId],
                        play: false // Nicht sofort abspielen
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Fehler beim Übertragen der Wiedergabe:', error);
                    // Handle specific errors, e.g., if device is not active
                } else {
                    console.log('Wiedergabe erfolgreich auf das Gerät übertragen:', targetDeviceId);
                }
            } catch (error) {
                console.error('Netzwerkfehler beim Übertragen der Wiedergabe:', error);
            }
        }

        // --- Phase 2: Spielstart & UI-Grundlagen ---

        // 2.2. Spielstart-Logik
        function startGame() {
            if (!gameStarted) return; // Spiel kann nur gestartet werden, wenn welcomeAnimationShown true ist

            addBounceAnimation(logoButton); // Bounce-Effekt beim Klick
            logoButton.classList.add('blurred'); // Logo-Button inaktiv machen

            // Generiere Speed-Runden für das neue Spiel
            generateSpeedRounds();

            setTimeout(() => {
                document.body.style.backgroundColor = '#0000FF'; // Hintergrund zu Blau (Spieler 1)
                showScreen(diceScreen); // Zum Würfel-Bildschirm wechseln
                diceAnimation.style.display = 'block'; // Würfel-Animation anzeigen
                diceButtonsContainer.classList.add('hidden'); // Würfel-Buttons ausblenden
                setTimeout(() => {
                    diceAnimation.style.display = 'none'; // Würfel-Animation ausblenden
                    diceButtonsContainer.classList.remove('hidden'); // Würfel-Buttons einblenden
                }, 4000); // 4 Sekunden für Würfel-Animation
            }, 300); // Kurzes setTimeout, damit der Bounce-Effekt abgeschlossen ist
        }

        // --- Phase 3: Würfel- & Genre-Auswahl ---

        // 3.2. Würfel-Logik
        function handleDiceSelection(event) {
            const button = event.currentTarget;
            addBounceAnimation(button);
            selectedDiceValue = parseInt(button.dataset.diceValue);

            switch (selectedDiceValue) {
                case 3:
                case 4:
                case 5:
                    gameDuration = 7000; // 7 Sekunden
                    break;
                case 7:
                    gameDuration = 2000; // 2 Sekunden (Speed-Round-Verhalten)
                    break;
            }
            maxPoints = selectedDiceValue;
            listenAttempts = selectedDiceValue;
            attemptsMade = 0; // Setze Versuche für die neue Runde zurück

            setTimeout(() => {
                showScreen(genreScreen); // Zum Genre-Bildschirm wechseln
                resetGenreButtons(); // Setze Genre-Buttons zurück
                // Überprüfe, ob es eine Speed-Round ist
                const currentRoundForPlayer = (currentPlayer === 1) ? Math.ceil(currentRound / 2) : Math.ceil(currentRound / 2);
                isSpeedRound = (currentPlayer === 1 && speedRoundsPlayer1.includes(currentRoundForPlayer)) ||
                               (currentPlayer === 2 && speedRoundsPlayer2.includes(currentRoundForPlayer));

                if (selectedDiceValue === 7) { // Fall B: Würfel 7, Spieler wählt Genre selbst
                    genreButtons.forEach(btn => btn.classList.remove('inactive'));
                } else { // Fall A: Würfel 3, 4, 5, Zufallsauswahl
                    startGenreRandomAnimation();
                }
            }, 300);
        }

        function resetGenreButtons() {
            genreButtons.forEach(btn => {
                btn.classList.remove('inactive');
                btn.classList.remove('bounce-animation');
                btn.style.opacity = '1'; // Ensure full opacity
                btn.style.filter = 'none'; // Ensure no filter
                btn.style.pointerEvents = 'auto'; // Ensure clickable
            });
        }

        function startGenreRandomAnimation() {
            let intervalCount = 0;
            const maxIntervals = 20; // Blinks for 4 seconds (20 * 200ms)
            const blinkInterval = setInterval(() => {
                genreButtons.forEach(btn => btn.classList.toggle('inactive')); // Einfaches Blinken
                intervalCount++;
                if (intervalCount >= maxIntervals) {
                    clearInterval(blinkInterval);
                    // Zufälliges Genre auswählen und nur dieses aktiv lassen
                    const randomIndex = Math.floor(Math.random() * genreButtons.length);
                    genreButtons.forEach((btn, index) => {
                        if (index !== randomIndex) {
                            btn.classList.add('inactive');
                        } else {
                            btn.classList.remove('inactive');
                            selectedGenreId = btn.dataset.genreId; // Speichere das zufällig ausgewählte Genre
                        }
                    });
                }
            }, 200);
        }

        // 3.4. Genre-Auswahl-Logik
        function handleGenreSelection(event) {
            const button = event.currentTarget;
            if (button.classList.contains('inactive') && selectedDiceValue !== 7) {
                // Bei Würfel 3,4,5 muss der aktive Button geklickt werden
                addBounceAnimation(button); // Zeige Bounce-Effekt auch bei Klick auf inaktiven Button
                return;
            }

            addBounceAnimation(button);
            selectedGenreId = button.dataset.genreId;

            setTimeout(async () => {
                showScreen(guessScreen);
                // Setze Play-Button auf Logo-Image
                playButtonImage.src = logoImage.src;
                playButton.classList.remove('blurred'); // Play-Button aktiv
                revealButton.classList.add('hidden'); // AUFLÖSEN Button ausblenden
                songInfoDisplay.classList.add('hidden'); // Song-Info ausblenden
                correctButton.classList.add('hidden'); // RICHTIG Button ausblenden
                wrongButton.classList.add('hidden'); // FALSCH Button ausblenden

                await loadRandomTrack(); // Lade den ersten Track für die Runde

                if (isSpeedRound) {
                    displaySpeedRound();
                }
                updatePlayerInfo();
            }, 300);
        }

        // --- Phase 4: Rate-Bildschirm & Spielerwechsel ---

        // 4.2. Song-Wiedergabe
        async function loadRandomTrack() {
            const playlistIds = genrePlaylists[selectedGenreId];
            const randomPlaylistId = playlistIds[Math.floor(Math.random() * playlistIds.length)];

            try {
                const response = await fetch(`https://api.spotify.com/v1/playlists/${randomPlaylistId}/tracks?limit=50`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) throw new Error('Failed to fetch playlist tracks');
                const data = await response.json();
                const tracks = data.items.filter(item => item.track && item.track.preview_url); // Nur Tracks mit Preview-URL

                if (tracks.length === 0) {
                    console.warn('Keine Tracks mit Preview-URL in dieser Playlist gefunden. Versuche eine andere Playlist.');
                    // Fallback: Versuche eine andere Playlist oder zeige Fehlermeldung
                    alert('Leider keine spielbaren Songs in diesem Genre gefunden. Bitte wähle ein anderes Genre.');
                    showScreen(genreScreen);
                    return;
                }

                const randomTrackIndex = Math.floor(Math.random() * tracks.length);
                currentTrack = tracks[randomTrackIndex].track;
                currentTrackDuration = currentTrack.duration_ms;

                // Zufällige Startposition (nicht am Ende des Songs)
                // Stelle sicher, dass genügend Zeit für die Wiedergabedauer bleibt
                const maxOffset = currentTrackDuration - gameDuration;
                currentTrackStartOffset = Math.floor(Math.random() * Math.max(0, maxOffset));

                console.log('Geladener Track:', currentTrack.name, 'von', currentTrack.artists[0].name);
                console.log('Start-Offset:', currentTrackStartOffset, 'ms');

                // Aktiviere Play-Button erst, wenn Track geladen ist
                playButton.classList.remove('blurred');
            } catch (error) {
                console.error('Fehler beim Laden des Tracks:', error);
                alert('Fehler beim Laden des Songs. Bitte versuche es erneut oder wähle ein anderes Genre.');
                showScreen(genreScreen); // Zurück zum Genre-Bildschirm
            }
        }

        async function playTrackSnippet() {
            if (!currentTrack || !deviceId) {
                console.error('Kein Track geladen oder Gerät nicht bereit.');
                return;
            }

            addBounceAnimation(playButton);
            playButton.classList.add('blurred'); // Play-Button inaktiv während Wiedergabe
            attemptsMade++;
            attemptsLeftText.textContent = `Hörversuche: ${listenAttempts - attemptsMade}`;

            try {
                await player.seek(currentTrackStartOffset); // Springe zur zufälligen Startposition
                await player.resume(); // Starte die Wiedergabe

                // Setze einen Timer, um die Wiedergabe nach gameDuration zu stoppen
                setTimeout(async () => {
                    await player.pause();
                    console.log('Wiedergabe gestoppt.');
                    if (attemptsMade < listenAttempts) {
                        playButton.classList.remove('blurred'); // Play-Button wieder aktiv, wenn Versuche übrig
                    } else {
                        playButton.classList.add('blurred'); // Play-Button dauerhaft inaktiv
                    }

                    // Zeige AUFLÖSEN Button nach dem ersten Versuch
                    if (attemptsMade >= 1) {
                        revealButton.classList.remove('hidden');
                    }
                    // Wenn Speed-Round und Timer abgelaufen, automatisch auflösen
                    if (isSpeedRound && countdownDisplay.textContent === '0') {
                        revealSongInfo();
                    }

                }, gameDuration);
            } catch (error) {
                console.error('Fehler bei der Wiedergabe:', error);
                alert('Fehler bei der Wiedergabe des Songs. Bitte versuche es erneut.');
                playButton.classList.remove('blurred'); // Play-Button wieder aktiv bei Fehler
            }
        }

        // 4.3. Hörversuche & Auflösung
        function revealSongInfo() {
            if (!currentTrack) return;

            revealButton.classList.add('hidden'); // AUFLÖSEN Button ausblenden
            playButton.classList.add('blurred'); // Play-Button inaktiv
            songInfoDisplay.classList.remove('hidden'); // Song-Info anzeigen
            correctButton.classList.remove('hidden'); // RICHTIG Button anzeigen
            wrongButton.classList.remove('hidden'); // FALSCH Button anzeigen

            songCover.src = currentTrack.album.images[0]?.url || 'https://placehold.co/200x200/000000/FFFFFF?text=NO+COVER';
            songTitle.textContent = currentTrack.name;
            songArtist.textContent = currentTrack.artists.map(artist => artist.name).join(', ');
        }

        // 4.4. Spielerwechsel
        function handleAnswer(isCorrect) {
            addBounceAnimation(isCorrect ? correctButton : wrongButton);

            if (isCorrect) {
                const points = calculatePoints(selectedDiceValue, attemptsMade);
                if (currentPlayer === 1) {
                    player1Score += points;
                } else {
                    player2Score += points;
                }
                console.log(`Spieler ${currentPlayer} hat ${points} Punkte erhalten.`);
            }

            currentRound++; // Nächste Runde

            // Hintergrundfarbe wechseln und Spieler wechseln
            setTimeout(() => {
                if (currentRound > MAX_ROUNDS) {
                    endGame(); // Spiel beenden
                } else {
                    currentPlayer = (currentPlayer === 1) ? 2 : 1;
                    document.body.style.backgroundColor = (currentPlayer === 1) ? '#0000FF' : '#FF00FF'; // Blau für Spieler 1, Pink für Spieler 2
                    resetRoundState(); // Runde zurücksetzen
                    showScreen(diceScreen); // Zum Würfel-Bildschirm wechseln
                    diceAnimation.style.display = 'block'; // Würfel-Animation anzeigen
                    diceButtonsContainer.classList.add('hidden'); // Würfel-Buttons ausblenden
                    setTimeout(() => {
                        diceAnimation.style.display = 'none'; // Würfel-Animation ausblenden
                        diceButtonsContainer.classList.remove('hidden'); // Würfel-Buttons einblenden
                    }, 4000); // 4 Sekunden für Würfel-Animation
                }
            }, 300);
        }

        function resetRoundState() {
            selectedDiceValue = 0;
            gameDuration = 0;
            maxPoints = 0;
            listenAttempts = 0;
            attemptsMade = 0;
            selectedGenreId = '';
            currentTrack = null;
            currentTrackDuration = 0;
            currentTrackStartOffset = 0;
            isSpeedRound = false;
            clearInterval(countdownInterval); // Sicherstellen, dass der Countdown gestoppt ist
            countdownDisplay.classList.add('hidden'); // Countdown ausblenden
        }

        function updatePlayerInfo() {
            currentPlayerText.textContent = `Spieler ${currentPlayer} ist dran!`;
            attemptsLeftText.textContent = `Hörversuche: ${listenAttempts - attemptsMade}`;
        }

        // --- Phase 5: Punkte-System & Spielende ---

        function endGame() {
            document.body.style.background = 'linear-gradient(to right, #0000FF, #FF00FF)'; // Gradient Hintergrund
            showScreen(scoreScreen);
            player1ScoreDisplay.textContent = `Spieler 1: ${player1Score}`;
            player2ScoreDisplay.textContent = `Spieler 2: ${player2Score}`;

            setTimeout(() => {
                // Spiel-Reset nach 7 Sekunden
                document.body.style.background = 'black'; // Hintergrund zurück zu schwarz
                resetGame();
                showScreen(startScreen); // Zum Startbildschirm zurückkehren
                logoButton.classList.remove('blurred'); // Logo-Button aktiv machen
                gameStarted = true; // Spiel kann neu gestartet werden
            }, 7000);
        }

        function resetGame() {
            currentPlayer = 1;
            currentRound = 1;
            player1Score = 0;
            player2Score = 0;
            welcomeAnimationShown = true; // Überspringe Begrüßungsanimation beim Reset
            sessionStorage.setItem('welcomeAnimationShown', 'true');
            resetRoundState(); // Setze auch die Rundenvariablen zurück
            // Generiere neue Speed-Runden für das nächste Spiel
            generateSpeedRounds();
        }

        // --- Phase 6: Sonderfunktion "Speed-Round" ---

        function displaySpeedRound() {
            speedRoundDisplay.classList.remove('hidden');
            speedRoundDisplay.classList.add('speed-round-animation');
            setTimeout(() => {
                speedRoundDisplay.classList.add('hidden');
                speedRoundDisplay.classList.remove('speed-round-animation');
                startCountdown(10); // Starte 10-Sekunden-Countdown
            }, 4000); // 4 Sekunden für Speed-Round Animation
        }

        function startCountdown(seconds) {
            countdownDisplay.classList.remove('hidden');
            let remainingSeconds = seconds;
            countdownDisplay.textContent = remainingSeconds;

            countdownInterval = setInterval(() => {
                remainingSeconds--;
                countdownDisplay.textContent = remainingSeconds;

                if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    countdownDisplay.classList.add('hidden');
                    // Automatische Auflösung, wenn der Timer abläuft
                    if (guessScreen.classList.contains('flex')) { // Nur auflösen, wenn wir noch auf dem Rate-Bildschirm sind
                        revealSongInfo();
                    }
                }
            }, 1000);
        }

        // --- Event Listener ---

        loginButton.addEventListener('click', handleLogin);
        fullscreenOverlay.addEventListener('click', requestFullscreen);
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        window.addEventListener('orientationchange', checkOrientation);
        window.addEventListener('resize', checkOrientation); // Auch bei Resize prüfen

        logoButton.addEventListener('click', () => {
            if (gameStarted) { // Nur reagieren, wenn das Spiel gestartet werden kann
                startGame();
            }
        });

        diceButtons.forEach(button => {
            button.addEventListener('click', handleDiceSelection);
        });

        genreButtons.forEach(button => {
            button.addEventListener('click', handleGenreSelection);
        });

        playButton.addEventListener('click', playTrackSnippet);
        revealButton.addEventListener('click', revealSongInfo);
        correctButton.addEventListener('click', () => handleAnswer(true));
        wrongButton.addEventListener('click', () => handleAnswer(false));


        // Initialisierungslogik beim Laden der Seite
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                // Wenn ein Autorisierungscode vorhanden ist, tausche ihn gegen Tokens
                exchangeCodeForTokens(code);
                // Entferne den Code aus der URL, um sie sauber zu halten
                window.history.replaceState({}, document.title, REDIRECT_URI);
            } else {
                // Wenn kein Code vorhanden ist, überprüfe, ob Tokens bereits gespeichert sind
                accessToken = sessionStorage.getItem('access_token');
                if (accessToken) {
                    // Überprüfe Ablaufdatum des Tokens
                    const expiresAt = sessionStorage.getItem('token_expires_in');
                    if (expiresAt && Date.now() < parseInt(expiresAt)) {
                        // Token ist noch gültig, initialisiere SDK
                        initializeSpotifySDK();
                    } else {
                        // Token abgelaufen oder ungültig, zeige Login-Screen
                        console.log('Access Token abgelaufen oder ungültig. Bitte erneut anmelden.');
                        sessionStorage.clear(); // Lösche alte Tokens
                        showScreen(loginScreen);
                    }
                } else {
                    // Kein Access Token vorhanden, zeige Login-Screen an
                    showScreen(loginScreen);
                }
            }
            // Überprüfe die Ausrichtung sofort beim Laden
            checkOrientation();
        });

        // Lade die Bilder für die Platzhalter
        // Da die Bilder im selben Ordner liegen sollen, hier nur die Namen.
        // Falls die Bilder nicht verfügbar sind, werden die Placeholders verwendet.
        // Im echten Einsatz müssten diese Bilder im selben Verzeichnis wie die HTML-Datei liegen.
        // Beispiel:
        // const spotifyIconPath = 'spotify_icon.png';
        // const logo3Path = 'logo3.png';
        // const wAniPath = 'w-ani.gif';
        // const w3Path = 'w-3.png';
        // const w4Path = 'w-4.png';
        // const w5Path = 'w-5.png';
        // const w7Path = 'w-7.png';

        // Die Placeholder-URLs sind nur für die Demonstration hier eingefügt.
        // In einer echten Bereitstellung würden die tatsächlichen Bildpfade verwendet.
        document.getElementById('login-button').querySelector('img').src = 'https://placehold.co/30x30/1DB954/FFFFFF?text=S'; // spotify_icon.png
        logoImage.src = 'https://placehold.co/256x256/000000/FFFFFF?text=LOGO'; // logo3.png
        diceAnimation.src = 'https://placehold.co/300x300/000000/FFFFFF?text=DICE+ANIM'; // w-ani.gif
        document.querySelector('.dice-button[data-dice-value="3"] img').src = 'https://placehold.co/128x128/000000/FFFFFF?text=W3'; // w-3.png
        document.querySelector('.dice-button[data-dice-value="4"] img').src = 'https://placehold.co/128x128/000000/FFFFFF?text=W4'; // w-4.png
        document.querySelector('.dice-button[data-dice-value="5"] img').src = 'https://placehold.co/128x128/000000/FFFFFF?text=W5'; // w-5.png
        document.querySelector('.dice-button[data-dice-value="7"] img').src = 'https://placehold.co/128x128/000000/FFFFFF?text=W7'; // w-7.png
        playButtonImage.src = 'https://placehold.co/192x192/000000/FFFFFF?text=PLAY'; // logo3.png (als Play-Button)

    </script>
</body>
</html>
