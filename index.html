<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRACK ATTACK</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Allgemeine Stile und Mobile-First-Design */
        :root {
            --player1-color: #4A90E2; /* Blau */
            --player2-color: #E24A90; /* Pink */
            --text-color: white;
            --button-bg: black;
            --button-border: linear-gradient(to right, var(--player1-color), var(--player2-color), var(--text-color));
            --spotify-green: #1DB954;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: black;
            color: var(--text-color);
            overflow: hidden; /* Verhindert Scrollen */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.5s ease-in-out;
            touch-action: manipulation; /* Verbessert Touch-Reaktion */
        }

        /* Verhindert Aufleuchten bei Klick und Textauswahl */
        a, button, input, textarea, select, * {
            -webkit-tap-highlight-color: transparent; /* Für Webkit-Browser (iOS, Android Chrome) */
            -webkit-touch-callout: none; /* Deaktiviert das Kontextmenü bei langem Drücken auf iOS */
            -webkit-user-select: none; /* Verhindert Textauswahl */
            -moz-user-select: none; /* Für Firefox */
            -ms-user-select: none; /* Für Internet Explorer/Edge */
            user-select: none; /* Standard für andere Browser */
            outline: none !important; /* Entfernt den Fokus-Outline */
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            text-align: center;
            position: relative;
            box-sizing: border-box;
            padding: 20px;
        }

        /* Overlay für Geräteausrichtung */
        #orientation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 2em;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        #orientation-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Fullscreen-Screen */
        #fullscreen-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            font-size: 2em;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        #fullscreen-screen.active {
            opacity: 1;
            visibility: visible;
        }

        /* Login-Seite */
        #login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }

        #login-screen p {
            font-size: 1.5em;
            margin-bottom: 30px;
        }

        .spotify-login-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--spotify-green);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            text-decoration: none;
            transition: transform 0.2s ease, background-color 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: none;
            cursor: pointer;
        }

        .spotify-login-button:hover {
            transform: translateY(-2px);
            background-color: #1ed760;
        }

        .spotify-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            fill: white; /* Für SVG-Icons */
        }

        /* Logo-Button (Spielstart/Play) */
        #logo-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            transition: filter 0.3s ease;
            position: relative;
            z-index: 1;
        }

        #logo-button img {
            width: 250px; /* Standardgröße für Landscape */
            height: auto;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s ease;
        }

        #logo-button.inactive img {
            filter: blur(5px);
            pointer-events: none;
        }

        /* Bounce-Animation */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }

        .bounce-animation {
            animation: bounce 1s ease-in-out;
        }

        /* Würfel- und Genre-Bildschirme */
        #dice-screen, #genre-screen, #guess-screen, #score-screen, #speed-round-overlay {
            display: none; /* Standardmäßig ausgeblendet */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        #dice-screen.active, #genre-screen.active, #guess-screen.active, #score-screen.active, #speed-round-overlay.active {
            display: flex;
        }

        #dice-animation {
            width: 200px;
            height: 200px;
            background-color: #333;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            font-weight: bold;
            color: var(--text-color);
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); opacity: 0.7; }
            to { transform: scale(1.1); opacity: 1; }
        }

        .dice-buttons, .genre-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .dice-button img {
            width: 100px;
            height: 100px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.3s ease;
        }

        .dice-button img:hover {
            transform: scale(1.05);
        }

        .dice-button.inactive img, .genre-button.inactive {
            filter: grayscale(100%) blur(3px);
            pointer-events: none;
            opacity: 0.6;
        }

        .genre-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            border: 3px solid transparent;
            border-image: var(--button-border);
            border-image-slice: 1;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.3s ease, border-image 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative; /* For blinking effect */
        }

        .genre-button:hover:not(.inactive) {
            transform: translateY(-3px);
        }

        /* Genre Blinking Animation for random selection */
        @keyframes blink-border {
            0% { border-image: var(--button-border); }
            50% { border-image: none; border-color: transparent; }
            100% { border-image: var(--button-border); }
        }

        .genre-blinking {
            animation: blink-border 0.5s infinite alternate;
        }

        /* Guess Screen */
        #guess-screen-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #guess-screen-content #logo-button {
            margin-bottom: 20px;
        }

        #resolve-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            border: 3px solid transparent;
            border-image: var(--button-border);
            border-image-slice: 1;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
            display: none; /* Initially hidden */
        }

        #resolve-button.active {
            display: block;
        }

        #song-info {
            display: none; /* Initially hidden */
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        #song-info.active {
            display: flex;
        }

        #album-cover {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        #song-details p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        .judgment-buttons {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .judgment-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            border: 3px solid transparent;
            border-image: var(--button-border);
            border-image-slice: 1;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .judgment-button.correct {
            border-image: linear-gradient(to right, #28a745, #218838); /* Green border */
            border-image-slice: 1;
        }

        .judgment-button.wrong {
            border-image: linear-gradient(to right, #dc3545, #c82333); /* Red border */
            border-image-slice: 1;
        }

        /* Score Screen */
        #score-screen {
            background: linear-gradient(to right, var(--player1-color), var(--player2-color));
            transition: background 0.5s ease-in-out;
        }

        #score-screen.active {
            display: flex;
            flex-direction: row; /* nebeneinander */
            justify-content: space-around;
            align-items: center;
        }

        .player-score {
            font-size: 5em;
            font-weight: bold;
            color: var(--text-color);
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* Speed Round Overlay */
        #speed-round-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 900;
        }

        #speed-round-text {
            font-size: 4em;
            font-weight: bold;
            color: var(--text-color);
            animation: zoom-fade 2s forwards;
            opacity: 0;
        }

        @keyframes zoom-fade {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        #countdown-timer {
            font-size: 8em;
            font-weight: bold;
            color: var(--text-color);
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
            display: none; /* Initially hidden */
        }

        #countdown-timer.active {
            display: block;
        }

        /* Allgemeine Button-Stile für Konsistenz */
        .game-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            border: 3px solid transparent;
            border-image: var(--button-border);
            border-image-slice: 1;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.3s ease, filter 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .game-button:hover:not(.inactive) {
            transform: translateY(-3px);
        }

        .game-button.inactive {
            filter: grayscale(100%) blur(3px);
            pointer-events: none;
            opacity: 0.6;
        }

        /* Responsive Anpassungen für Landscape */
        @media screen and (orientation: landscape) {
            #logo-button img {
                width: 200px; /* Etwas kleiner im Landscape */
            }
            .dice-button img {
                width: 80px;
                height: 80px;
            }
            .genre-button, .game-button, .spotify-login-button {
                padding: 12px 25px;
                font-size: 1.1em;
            }
            #login-screen p {
                font-size: 1.2em;
            }
            #orientation-overlay, #fullscreen-screen {
                font-size: 1.5em;
            }
            #speed-round-text {
                font-size: 3em;
            }
            #countdown-timer {
                font-size: 6em;
            }
            .player-score {
                font-size: 4em;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app-container">
        <!-- Phase 1: Authentifizierung & Geräte-Einrichtung -->
        <div id="login-screen" class="screen active">
            <p>Please log in with your Spotify-Premium-Account</p>
            <button id="login-button" class="spotify-login-button">
                <svg class="spotify-icon" viewBox="0 0 167.6 167.6">
                    <path fill="currentColor" d="M83.8 0C37.5 0 0 37.5 0 83.8c0 46.3 37.5 83.8 83.8 83.8 46.3 0 83.8-37.5 83.8-83.8C167.6 37.5 130.1 0 83.8 0zm37.2 120.8c-2.5 4.1-7.7 5.4-11.8 2.9-16.7-10.1-37.2-12.4-62.4-7.2-4.6 1-9.3-1.5-10.3-6.1-1-4.6 1.5-9.3 6.1-10.3 29.5-6.4 53.3-3.7 72.4 7.7 4 2.5 5.4 7.7 2.9 11.8zm10.7-25.7c-3.1 5.1-9.9 6.8-15 3.7-19.9-12.1-50.7-15.9-79.6-8.7-5.5 1.4-11.2-1.8-12.6-7.3-1.4-5.5 1.8-11.2 7.3-12.6 34.6-8.8 69.3-4.5 93.2 9.4 5.1 3.1 6.8 9.9 3.7 15zm.2-26.9c-3.6 5.9-11.5 7.9-17.4 4.3-22.9-14-57.9-18.1-97.4-9.7-6.1 1.3-12.3-2.1-13.6-8.2-1.3-6.1 2.1-12.3 8.2-13.6 44.9-9.5 83.3-4.8 109.1 11.4 5.9 3.6 7.9 11.5 4.3 17.4z"/>
                </svg>
                LOG IN
            </button>
        </div>

        <div id="orientation-overlay">
            <p>Please rotate your device to landscape mode</p>
        </div>

        <div id="fullscreen-screen">
            <p>Click to Fullscreen</p>
        </div>

        <!-- Phase 2: Spielstart & UI-Grundlagen -->
        <div id="start-screen" class="screen">
            <button id="logo-button">
                <!-- Placeholder for logo3.png -->
                <svg width="250" height="250" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="0" y="0" width="200" height="200" rx="100" fill="#333"/>
                    <path d="M70 60 L130 60 L130 140 L70 140 Z" fill="white"/>
                    <path d="M70 60 L100 30 L130 60" stroke="white" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
                    <text x="50%" y="105%" dominant-baseline="auto" text-anchor="middle" font-size="20" fill="white" font-weight="bold">TRACK ATTACK</text>
                </svg>
            </button>
        </div>

        <!-- Phase 3: Würfel- & Genre-Auswahl -->
        <div id="dice-screen" class="screen">
            <div id="dice-animation">Würfel animation</div> <!-- Placeholder for w-ani.gif -->
            <div class="dice-buttons">
                <button class="dice-button game-button" data-value="3">
                    <img src="https://placehold.co/100x100/000000/FFFFFF?text=3" alt="Würfel 3">
                </button>
                <button class="dice-button game-button" data-value="4">
                    <img src="https://placehold.co/100x100/000000/FFFFFF?text=4" alt="Würfel 4">
                </button>
                <button class="dice-button game-button" data-value="5">
                    <img src="https://placehold.co/100x100/000000/FFFFFF?text=5" alt="Würfel 5">
                </button>
                <button class="dice-button game-button" data-value="7">
                    <img src="https://placehold.co/100x100/000000/FFFFFF?text=7" alt="Würfel 7">
                </button>
            </div>
        </div>

        <div id="genre-screen" class="screen">
            <div class="genre-buttons">
                <button class="genre-button game-button" data-genre="punk-rock">Punk Rock (90's & 00')</button>
                <button class="genre-button game-button" data-genre="pop-hits">Pop Hits 2000-2025</button>
                <button class="genre-button game-button" data-genre="greatest-hits">Die größten Hits aller Zeiten</button>
                <button class="genre-button game-button" data-genre="disney">Disney Songs</button>
            </div>
        </div>

        <!-- Phase 4: Rate-Bildschirm & Spielerwechsel -->
        <div id="guess-screen" class="screen">
            <div id="guess-screen-content">
                <button id="play-button" class="game-button">
                    <!-- Reusing logo-button for play -->
                    <svg width="150" height="150" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="0" y="0" width="200" height="200" rx="100" fill="#333"/>
                        <path d="M70 60 L130 60 L130 140 L70 140 Z" fill="white"/>
                        <path d="M70 60 L100 30 L130 60" stroke="white" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button id="resolve-button" class="game-button">AUFLÖSEN</button>

                <div id="song-info">
                    <img id="album-cover" src="https://placehold.co/150x150/CCCCCC/000000?text=Album" alt="Album Cover">
                    <div id="song-details">
                        <p id="song-title">Titel: </p>
                        <p id="song-artist">Interpret: </p>
                    </div>
                    <div class="judgment-buttons">
                        <button id="correct-button" class="judgment-button game-button correct">RICHTIG</button>
                        <button id="wrong-button" class="judgment-button game-button wrong">FALSCH</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase 5: Punkte-System & Spielende -->
        <div id="score-screen" class="screen">
            <div class="player-score" id="player1-final-score">0</div>
            <div class="player-score" id="player2-final-score">0</div>
        </div>

        <!-- Phase 6: Sonderfunktion "Speed-Round" -->
        <div id="speed-round-overlay">
            <p id="speed-round-text">Speed-Round</p>
            <p id="countdown-timer"></p>
        </div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script type="module">
        // Firebase Konfiguration (Platzhalter, da nicht explizit für Datenpersistenz angefordert)
        // Dies ist notwendig, um die globalen Variablen __app_id, __firebase_config, __initial_auth_token zu nutzen,
        // falls sie im Canvas-Environment bereitgestellt werden.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globale Variablen für Firebase und App-ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-track-attack-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        // let db; // Firestore Instanz, falls benötigt

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            // db = getFirestore(app); // Initialisiere Firestore, falls benötigt

            // Firebase Authentifizierung
            async function authenticateFirebase() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase: Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase: Signed in anonymously.");
                    }
                    // const userId = auth.currentUser?.uid || crypto.randomUUID();
                    // console.log("Firebase User ID:", userId);
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                }
            }
            authenticateFirebase();
        } else {
            console.warn("Firebase config not found. Running without Firebase features.");
        }


        // --- Wichtige Parameter ---
        const CLIENT_ID = '53257f6a1c144d3f929a60d691a0c6f6';
        const REDIRECT_URI = 'https://dookye.github.io/TRACK-ATTACK/';
        const SCOPES = 'streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state';

        // --- DOM-Elemente ---
        const appContainer = document.getElementById('app-container');
        const loginScreen = document.getElementById('login-screen');
        const orientationOverlay = document.getElementById('orientation-overlay');
        const fullscreenScreen = document.getElementById('fullscreen-screen');
        const startScreen = document.getElementById('start-screen');
        const logoButton = document.getElementById('logo-button');
        const loginButton = document.getElementById('login-button');
        const diceScreen = document.getElementById('dice-screen');
        const diceAnimation = document.getElementById('dice-animation');
        const diceButtonsContainer = document.querySelector('.dice-buttons');
        const genreScreen = document.getElementById('genre-screen');
        const genreButtonsContainer = document.querySelector('.genre-buttons');
        const guessScreen = document.getElementById('guess-screen');
        const playButton = document.getElementById('play-button'); // Reused logo-button SVG
        const resolveButton = document.getElementById('resolve-button');
        const songInfoDiv = document.getElementById('song-info');
        const albumCoverImg = document.getElementById('album-cover');
        const songTitleP = document.getElementById('song-title');
        const songArtistP = document.getElementById('song-artist');
        const correctButton = document.getElementById('correct-button');
        const wrongButton = document.getElementById('wrong-button');
        const scoreScreen = document.getElementById('score-screen');
        const player1FinalScore = document.getElementById('player1-final-score');
        const player2FinalScore = document.getElementById('player2-final-score');
        const speedRoundOverlay = document.getElementById('speed-round-overlay');
        const speedRoundText = document.getElementById('speed-round-text');
        const countdownTimer = document.getElementById('countdown-timer');

        // --- Spielzustand-Variablen ---
        let accessToken = null;
        let spotifyPlayer = null;
        let deviceId = null;
        let currentTrack = null;
        let currentDiceValue = 0;
        let gameDuration = 0; // In Sekunden
        let maxPoints = 0;
        let listenAttempts = 0;
        let attemptsMade = 0;
        let player1Score = 0;
        let player2Score = 0;
        let currentPlayer = 1; // 1 oder 2
        let currentRound = 1; // Pro Spieler, insgesamt 20 Runden
        let isGameStarted = false;
        let isPlaying = false;
        let isSpeedRound = false;
        let speedRoundCountdownInterval = null;
        let speedRoundPlayer1Round = Math.floor(Math.random() * 10) + 1;
        let speedRoundPlayer2Round = Math.floor(Math.random() * 10) + 1;
        let animationShown = sessionStorage.getItem('welcomeAnimationShown') === 'true';

        // Spotify Playlist IDs nach Genre
        const GENRES = {
            'punk-rock': ['39sVxPTg7BKwrf2MfgrtcD', '7ITmaFa2rOhXAmKmUUCG9E'],
            'pop-hits': ['6mtYuOxzl58vSGnEDtZ9uB', '34NbomaTu7YuOYnky8nLXL'],
            'greatest-hits': ['2si7ChS6Y0hPBt4FsobXpg', '2y09fNnXHvoqc1WGHvbhkZ'],
            'disney': ['3Bilb56eeS7db5f3DTEwMR', '2bhbwexk7c6yJrEB4CtuY8']
        };
        let selectedGenrePlaylists = [];

        // --- Hilfsfunktionen ---

        /**
         * Wechselt die aktive Ansicht auf dem Bildschirm.
         * @param {HTMLElement} screenToShow - Das anzuzeigende DOM-Element.
         */
        function showScreen(screenToShow) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
            screenToShow.classList.add('active');
        }

        /**
         * Generiert einen zufälligen String für PKCE.
         * @param {number} length - Die Länge des Strings.
         * @returns {string} Der zufällige String.
         */
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let text = '';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        /**
         * Codiert einen String mit SHA256.
         * @param {string} plain - Der zu codierende String.
         * @returns {Promise<ArrayBuffer>} Der SHA256-Hash als ArrayBuffer.
         */
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        /**
         * Codiert einen ArrayBuffer in einen Base64Url-String.
         * @param {ArrayBuffer} buffer - Der zu codierende ArrayBuffer.
         * @returns {string} Der Base64Url-String.
         */
        function base64urlencode(buffer) {
            const bytes = new Uint8Array(buffer);
            let str = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                str += String.fromCharCode(bytes[i]);
            }
            return btoa(str)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        /**
         * Startet den Spotify OAuth 2.0 PKCE Flow.
         */
        async function redirectToSpotifyAuth() {
            const codeVerifier = generateRandomString(128);
            sessionStorage.setItem('code_verifier', codeVerifier);

            const hashed = await sha256(codeVerifier);
            const codeChallenge = base64urlencode(hashed);

            const authUrl = new URL('https://accounts.spotify.com/authorize');
            const params = {
                response_type: 'code',
                client_id: CLIENT_ID,
                scope: SCOPES,
                redirect_uri: REDIRECT_URI,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge,
            };
            authUrl.search = new URLSearchParams(params).toString();
            window.location.href = authUrl.toString();
        }

        /**
         * Tauscht den Autorisierungscode gegen ein Access Token.
         * @param {string} code - Der Autorisierungscode von Spotify.
         * @returns {Promise<void>}
         */
        async function exchangeCodeForToken(code) {
            const codeVerifier = sessionStorage.getItem('code_verifier');
            if (!codeVerifier) {
                console.error('Code Verifier not found in session storage.');
                return;
            }

            const tokenUrl = 'https://accounts.spotify.com/api/token';
            const params = {
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: REDIRECT_URI,
                client_id: CLIENT_ID,
                code_verifier: codeVerifier,
            };

            try {
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(params).toString(),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Failed to exchange code for token:', errorData);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                accessToken = data.access_token;
                sessionStorage.setItem('spotify_access_token', accessToken);
                console.log('Access Token erhalten:', accessToken);
                initializeSpotifySdk();
            } catch (error) {
                console.error('Fehler beim Token-Austausch:', error);
                // Optional: Benutzer zurück zur Login-Seite leiten
                showScreen(loginScreen);
            }
        }

        /**
         * Initialisiert das Spotify Web Playback SDK.
         */
        function initializeSpotifySdk() {
            if (!accessToken) {
                console.error('Access Token nicht verfügbar für SDK-Initialisierung.');
                return;
            }

            window.onSpotifyWebPlaybackSDKReady = () => {
                spotifyPlayer = new Spotify.Player({
                    name: 'TRACK ATTACK Player',
                    getOAuthToken: cb => { cb(accessToken); },
                    volume: 0.5
                });

                // Verbindung herstellen
                spotifyPlayer.addListener('ready', ({ device_id }) => {
                    deviceId = device_id;
                    console.log('Ready with Device ID', deviceId);
                    // Nach erfolgreicher Initialisierung zur Ausrichtungsprüfung
                    checkOrientationAndFullscreen();
                });

                spotifyPlayer.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                });

                spotifyPlayer.addListener('initialization_error', ({ message }) => {
                    console.error('Failed to initialize', message);
                    alert('Fehler beim Initialisieren des Spotify Players. Stellen Sie sicher, dass Spotify Premium aktiv ist und Sie eingeloggt sind.');
                    showScreen(loginScreen); // Zurück zum Login
                });

                spotifyPlayer.addListener('authentication_error', ({ message }) => {
                    console.error('Authentication error', message);
                    alert('Spotify Authentifizierungsfehler. Bitte versuchen Sie sich erneut anzumelden.');
                    showScreen(loginScreen); // Zurück zum Login
                });

                spotifyPlayer.addListener('account_error', ({ message }) => {
                    console.error('Account error', message);
                    alert('Spotify Account Fehler. Stellen Sie sicher, dass Sie ein Premium-Konto haben.');
                    showScreen(loginScreen); // Zurück zum Login
                });

                spotifyPlayer.connect();
            };
        }

        /**
         * Überprüft die Geräteausrichtung und erzwingt den Vollbildmodus.
         */
        function checkOrientationAndFullscreen() {
            const isLandscape = window.matchMedia("(orientation: landscape)").matches;

            if (!isLandscape) {
                orientationOverlay.classList.add('active');
                fullscreenScreen.classList.remove('active');
                appContainer.style.display = 'none'; // Verbirgt den Rest der App
            } else {
                orientationOverlay.classList.remove('active');
                appContainer.style.display = 'flex'; // Zeigt den Rest der App
                // Wenn im Querformat, dann zum Vollbildschirm, falls nicht bereits im Vollbild
                if (!document.fullscreenElement) {
                    showScreen(fullscreenScreen);
                } else {
                    // Wenn bereits im Vollbild, direkt zur Startanimation
                    if (!animationShown) {
                        showWelcomeAnimation();
                    } else {
                        showScreen(startScreen);
                        logoButton.classList.remove('inactive');
                    }
                }
            }
        }

        /**
         * Aktiviert den Vollbildmodus.
         */
        function activateFullscreen() {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.mozRequestFullScreen) { /* Firefox */
                document.documentElement.mozRequestFullScreen();
            } else if (document.documentElement.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) { /* IE/Edge */
                document.documentElement.msRequestFullscreen();
            }
        }

        /**
         * Überwacht den Vollbildmodus.
         */
        function monitorFullscreen() {
            if (!document.fullscreenElement) {
                // Wenn Vollbild verlassen wurde, und Gerät im Querformat ist, zeige Fullscreen-Screen erneut
                if (window.matchMedia("(orientation: landscape)").matches) {
                    showScreen(fullscreenScreen);
                }
            } else {
                // Wenn Vollbild aktiv, und Welcome Animation noch nicht gezeigt wurde
                if (!animationShown) {
                    showWelcomeAnimation();
                } else {
                    showScreen(startScreen);
                    logoButton.classList.remove('inactive');
                }
            }
        }

        /**
         * Zeigt die einmalige Begrüßungsanimation.
         */
        function showWelcomeAnimation() {
            animationShown = true;
            sessionStorage.setItem('welcomeAnimationShown', 'true');
            showScreen(startScreen);
            logoButton.classList.add('bounce-animation');
            logoButton.classList.add('inactive'); // Inaktiv während Animation
            setTimeout(() => {
                logoButton.classList.remove('bounce-animation');
                logoButton.classList.remove('inactive'); // Aktiv nach Animation
            }, 1000); // Dauer der Bounce-Animation
        }

        /**
         * Berechnet die Punkte basierend auf Würfelwert und Versuchen.
         * @param {number} diceValue - Der Wert des gewählten Würfels.
         * @param {number} attemptsMade - Die Anzahl der genutzten Hörversuche.
         * @returns {number} Die berechneten Punkte.
         */
        function calculatePoints(diceValue, attemptsMade) {
            const points = diceValue - (attemptsMade - 1);
            return Math.max(1, points); // Mindestpunktzahl ist 1
        }

        /**
         * Wechselt den Hintergrund des Containers.
         * @param {string} color - Die Zielfarbe (z.B. 'blue', 'pink', 'black').
         */
        function changeBackground(color) {
            appContainer.style.backgroundColor = color;
        }

        /**
         * Wechselt den Spieler und aktualisiert den Hintergrund.
         */
        function switchPlayer() {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            if (currentPlayer === 1) {
                changeBackground(getComputedStyle(document.documentElement).getPropertyValue('--player1-color'));
            } else {
                changeBackground(getComputedStyle(document.documentElement).getPropertyValue('--player2-color'));
            }
            // Wenn Spieler 1 wieder dran ist, erhöhe die Runde
            if (currentPlayer === 1) {
                currentRound++;
            }
            console.log(`Spieler gewechselt zu: ${currentPlayer}, Runde: ${currentRound}`);
        }

        /**
         * Überprüft, ob es eine Speed-Round ist und startet sie gegebenenfalls.
         * @returns {boolean} True, wenn Speed-Round gestartet wurde, sonst False.
         */
        async function checkAndStartSpeedRound() {
            const targetSpeedRound = (currentPlayer === 1) ? speedRoundPlayer1Round : speedRoundPlayer2Round;

            if (currentRound === targetSpeedRound && !isSpeedRound) {
                isSpeedRound = true;
                console.log(`Speed-Round für Spieler ${currentPlayer} in Runde ${currentRound} aktiviert!`);

                speedRoundOverlay.classList.add('active');
                speedRoundText.style.animation = 'zoom-fade 2s forwards'; // Animation neu starten
                speedRoundText.style.opacity = '0'; // Zurücksetzen für erneute Animation
                countdownTimer.classList.remove('active'); // Countdown zunächst verstecken

                await new Promise(resolve => setTimeout(resolve, 4000)); // Warten auf "Speed-Round" Animation

                speedRoundText.style.animation = 'none'; // Animation zurücksetzen
                speedRoundOverlay.classList.remove('active');
                countdownTimer.classList.add('active');

                // Countdown starten
                let timeLeft = 10;
                countdownTimer.textContent = timeLeft;
                speedRoundCountdownInterval = setInterval(() => {
                    timeLeft--;
                    countdownTimer.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(speedRoundCountdownInterval);
                        console.log("Speed-Round Timer abgelaufen. Auflösen.");
                        resolveSong(); // Song automatisch auflösen
                    }
                }, 1000);
                return true;
            }
            return false;
        }

        /**
         * Holt eine zufällige Track-URI aus einer Playlist.
         * @param {string} playlistId - Die ID der Spotify-Playlist.
         * @returns {Promise<string|null>} Die Track-URI oder null bei Fehler.
         */
        async function getRandomTrackFromPlaylist(playlistId) {
            try {
                const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=50`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.items && data.items.length > 0) {
                    const tracks = data.items.filter(item => item.track && item.track.preview_url); // Nur Tracks mit Preview-URL
                    if (tracks.length > 0) {
                        const randomIndex = Math.floor(Math.random() * tracks.length);
                        return tracks[randomIndex].track;
                    }
                }
                return null;
            } catch (error) {
                console.error('Fehler beim Abrufen der Playlist-Tracks:', error);
                return null;
            }
        }

        /**
         * Spielt einen Songausschnitt über den Spotify Web Playback SDK.
         * @param {string} trackUri - Die URI des zu spielenden Tracks.
         * @param {number} startMs - Startposition in Millisekunden.
         * @param {number} durationMs - Dauer des Ausschnitts in Millisekunden.
         * @returns {Promise<void>}
         */
        async function playTrackSnippet(trackUri, startMs, durationMs) {
            if (!spotifyPlayer || !deviceId) {
                console.error('Spotify Player oder Device ID nicht bereit.');
                return;
            }

            try {
                // Transfer playback to our device
                await fetch('https://api.spotify.com/v1/me/player', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        device_ids: [deviceId],
                        play: false // Nicht sofort abspielen
                    })
                });

                // Play the track
                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        uris: [trackUri],
                        position_ms: startMs
                    })
                });

                isPlaying = true;
                playButton.classList.add('inactive'); // Play-Button inaktiv während Wiedergabe

                // Stoppe nach der angegebenen Dauer
                setTimeout(async () => {
                    if (isPlaying) { // Nur stoppen, wenn noch gespielt wird (nicht manuell gestoppt)
                        await spotifyPlayer.pause();
                        isPlaying = false;
                        console.log('Songausschnitt beendet.');

                        if (attemptsMade < listenAttempts) {
                            playButton.classList.remove('inactive'); // Play-Button wieder aktiv
                        } else {
                            playButton.classList.add('inactive'); // Keine Versuche mehr
                        }
                        resolveButton.classList.add('active'); // Auflösen-Button anzeigen
                    }
                }, durationMs);

            } catch (error) {
                console.error('Fehler beim Abspielen des Tracks:', error);
                alert('Fehler beim Abspielen des Songs. Bitte überprüfen Sie Ihre Spotify-Verbindung und Premium-Status.');
                playButton.classList.remove('inactive'); // Button wieder aktiv machen
            }
        }

        /**
         * Zeigt die Auflösung des Songs an.
         */
        function resolveSong() {
            clearInterval(speedRoundCountdownInterval); // Stoppt den Speed-Round Countdown, falls aktiv
            countdownTimer.classList.remove('active');
            speedRoundOverlay.classList.remove('active'); // Versteckt das Speed-Round Overlay

            if (currentTrack) {
                songTitleP.textContent = `Titel: ${currentTrack.name}`;
                songArtistP.textContent = `Interpret: ${currentTrack.artists.map(a => a.name).join(', ')}`;
                albumCoverImg.src = currentTrack.album.images[0]?.url || 'https://placehold.co/150x150/CCCCCC/000000?text=Album';
                songInfoDiv.classList.add('active');
                resolveButton.classList.remove('active'); // Auflösen-Button verstecken
                playButton.classList.add('inactive'); // Play-Button inaktiv lassen
            }
        }

        /**
         * Startet eine neue Runde.
         */
        async function startNewRound() {
            // Reset für die Runde
            currentDiceValue = 0;
            gameDuration = 0;
            maxPoints = 0;
            listenAttempts = 0;
            attemptsMade = 0;
            currentTrack = null;
            isSpeedRound = false; // Reset Speed-Round Status

            // UI-Elemente zurücksetzen
            songInfoDiv.classList.remove('active');
            resolveButton.classList.remove('active');
            playButton.classList.remove('inactive');
            albumCoverImg.src = 'https://placehold.co/150x150/CCCCCC/000000?text=Album';
            songTitleP.textContent = 'Titel: ';
            songArtistP.textContent = 'Interpret: ';

            // Zum Würfel-Bildschirm wechseln
            showScreen(diceScreen);
            diceAnimation.style.display = 'flex';
            diceButtonsContainer.style.display = 'none';

            // Würfel-Animation anzeigen
            await new Promise(resolve => setTimeout(resolve, 4000)); // 4 Sekunden warten
            diceAnimation.style.display = 'none';
            diceButtonsContainer.style.display = 'flex';

            // Alle Würfel-Buttons aktivieren
            document.querySelectorAll('.dice-button').forEach(button => {
                button.classList.remove('inactive');
            });
        }

        /**
         * Beendet das Spiel und zeigt die Punkte an.
         */
        async function endGame() {
            console.log("Spiel beendet!");
            showScreen(scoreScreen);
            player1FinalScore.textContent = player1Score;
            player2FinalScore.textContent = player2Score;
            appContainer.style.background = 'linear-gradient(to right, var(--player1-color), var(--player2-color))';

            await new Promise(resolve => setTimeout(resolve, 7000)); // 7 Sekunden anzeigen

            // Spiel zurücksetzen
            player1Score = 0;
            player2Score = 0;
            currentPlayer = 1;
            currentRound = 1;
            isGameStarted = false;
            // Neue Speed-Runden festlegen
            speedRoundPlayer1Round = Math.floor(Math.random() * 10) + 1;
            speedRoundPlayer2Round = Math.floor(Math.random() * 10) + 1;

            appContainer.style.background = 'black'; // Hintergrund zurücksetzen
            showScreen(startScreen);
            logoButton.classList.remove('inactive'); // Logo-Button für neues Spiel aktivieren
        }

        // --- Event Listener ---

        // Phase 1: Login
        loginButton.addEventListener('click', redirectToSpotifyAuth);

        // Phase 1: Fullscreen
        fullscreenScreen.addEventListener('click', activateFullscreen);
        document.addEventListener('fullscreenchange', monitorFullscreen);
        document.addEventListener('webkitfullscreenchange', monitorFullscreen);
        document.addEventListener('mozfullscreenchange', monitorFullscreen);
        document.addEventListener('MSFullscreenChange', monitorFullscreen);

        // Phase 1 & 2: Geräteausrichtung und Start-Screen
        window.addEventListener('resize', checkOrientationAndFullscreen);
        window.addEventListener('orientationchange', checkOrientationAndFullscreen);

        // Phase 2: Start-Screen Logo-Button
        logoButton.addEventListener('click', () => {
            if (!isGameStarted) {
                isGameStarted = true;
                logoButton.classList.add('bounce-animation');
                logoButton.classList.add('inactive'); // Inaktiv während Bounce
                setTimeout(() => {
                    logoButton.classList.remove('bounce-animation');
                    changeBackground(getComputedStyle(document.documentElement).getPropertyValue('--player1-color')); // Blau für Spieler 1
                    startNewRound(); // Wechsel zum Würfel-Bildschirm
                }, 500); // Kurzes setTimeout für Bounce-Effekt
            }
        });

        // Phase 3: Würfel-Auswahl
        diceButtonsContainer.addEventListener('click', (event) => {
            const targetButton = event.target.closest('.dice-button');
            if (targetButton && !targetButton.classList.contains('inactive')) {
                currentDiceValue = parseInt(targetButton.dataset.value);
                gameDuration = (currentDiceValue === 7) ? 2000 : 7000; // 2s oder 7s
                maxPoints = currentDiceValue;
                listenAttempts = currentDiceValue;
                console.log(`Würfel gewählt: ${currentDiceValue}, Dauer: ${gameDuration/1000}s, Max Punkte: ${maxPoints}, Versuche: ${listenAttempts}`);

                // Alle Würfel-Buttons inaktiv machen
                document.querySelectorAll('.dice-button').forEach(button => {
                    button.classList.add('inactive');
                });

                // Zum Genre-Bildschirm wechseln
                showScreen(genreScreen);
                // Alle Genre-Buttons aktivieren
                document.querySelectorAll('.genre-button').forEach(button => {
                    button.classList.remove('inactive');
                    button.classList.remove('genre-blinking'); // Blinking entfernen
                });

                // Überprüfen, ob Speed-Round
                checkAndStartSpeedRound().then(isSR => {
                    if (isSR) {
                        // Wenn Speed-Round, alle Genre-Buttons sind aktiv
                        console.log("Speed-Round aktiv, Spieler wählt Genre selbst.");
                    } else {
                        // Normale Runde, zufällige Auswahl oder Spieler wählt
                        if (currentDiceValue !== 7) { // Fall A: Würfel 3, 4, 5
                            console.log("Normale Runde, zufällige Genre-Auswahl.");
                            const genreButtons = Array.from(document.querySelectorAll('.genre-button'));
                            genreButtons.forEach(button => button.classList.add('genre-blinking')); // Alle blinken lassen

                            setTimeout(() => {
                                genreButtons.forEach(button => button.classList.remove('genre-blinking')); // Blinken stoppen
                                const randomIndex = Math.floor(Math.random() * genreButtons.length);
                                genreButtons.forEach((button, index) => {
                                    if (index !== randomIndex) {
                                        button.classList.add('inactive'); // Andere inaktiv machen
                                    }
                                });
                            }, 4000); // 4 Sekunden Zufallsanimation
                        } else { // Fall B: Würfel 7 (Speed-Round oder normale Runde, Spieler wählt)
                            console.log("Würfel 7, Spieler wählt Genre selbst.");
                            // Alle Buttons bleiben aktiv
                        }
                    }
                });
            }
        });

        // Phase 3: Genre-Auswahl
        genreButtonsContainer.addEventListener('click', async (event) => {
            const targetButton = event.target.closest('.genre-button');
            if (targetButton && !targetButton.classList.contains('inactive')) {
                const genreKey = targetButton.dataset.genre;
                selectedGenrePlaylists = GENRES[genreKey];
                console.log(`Genre gewählt: ${genreKey}`);

                // Zum Rate-Bildschirm wechseln
                showScreen(guessScreen);
                playButton.classList.remove('inactive'); // Play-Button aktivieren
            }
        });

        // Phase 4: Rate-Bildschirm - Play-Button
        playButton.addEventListener('click', async () => {
            if (isPlaying || attemptsMade >= listenAttempts) {
                return; // Nichts tun, wenn bereits spielt oder keine Versuche mehr
            }

            attemptsMade++;
            playButton.classList.add('bounce-animation'); // Bounce-Effekt beim Klick
            playButton.classList.add('inactive'); // Inaktiv während des Abspielens

            setTimeout(async () => {
                playButton.classList.remove('bounce-animation');
                // Zufällige Playlist und Track auswählen
                const randomPlaylistId = selectedGenrePlaylists[Math.floor(Math.random() * selectedGenrePlaylists.length)];
                currentTrack = await getRandomTrackFromPlaylist(randomPlaylistId);

                if (currentTrack) {
                    // Zufällige Startposition (nicht zu nah am Ende)
                    const trackDurationMs = currentTrack.duration_ms;
                    const maxStartMs = trackDurationMs - gameDuration - 1000; // 1 Sekunde Puffer
                    const startMs = Math.floor(Math.random() * Math.max(0, maxStartMs));
                    console.log(`Spiele Track: ${currentTrack.name} von ${currentTrack.artists[0].name} ab ${startMs}ms für ${gameDuration}ms`);
                    await playTrackSnippet(currentTrack.uri, startMs, gameDuration);
                } else {
                    console.error('Kein Track zum Abspielen gefunden.');
                    alert('Konnte keinen Song finden. Bitte versuchen Sie ein anderes Genre oder überprüfen Sie Ihre Spotify-Verbindung.');
                    playButton.classList.remove('inactive');
                }
            }, 200); // Kurzes Timeout für Bounce-Animation
            resolveButton.classList.add('active'); // AUFLÖSEN-Button anzeigen
        });

        // Phase 4: Rate-Bildschirm - AUFLÖSEN-Button
        resolveButton.addEventListener('click', resolveSong);

        // Phase 4: Rate-Bildschirm - RICHTIG/FALSCH-Buttons
        correctButton.addEventListener('click', () => {
            const points = calculatePoints(maxPoints, attemptsMade);
            if (currentPlayer === 1) {
                player1Score += points;
            } else {
                player2Score += points;
            }
            console.log(`Spieler ${currentPlayer} hat RICHTIG geraten. Punkte: ${points}. Gesamtscore: P1=${player1Score}, P2=${player2Score}`);
            if (currentRound > 10) { // 10 Runden pro Spieler, also 20 Songs insgesamt
                endGame();
            } else {
                switchPlayer();
                startNewRound();
            }
        });

        wrongButton.addEventListener('click', () => {
            console.log(`Spieler ${currentPlayer} hat FALSCH geraten. Keine Punkte.`);
            if (currentRound > 10) { // 10 Runden pro Spieler, also 20 Songs insgesamt
                endGame();
            } else {
                switchPlayer();
                startNewRound();
            }
        });

        // --- Initialisierung beim Laden der Seite ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const storedAccessToken = sessionStorage.getItem('spotify_access_token');

            if (code) {
                // Wenn ein Autorisierungscode in der URL ist, tausche ihn gegen ein Token
                history.replaceState(null, '', REDIRECT_URI); // Entferne den Code aus der URL
                exchangeCodeForToken(code);
            } else if (storedAccessToken) {
                // Wenn ein Token im Session Storage ist, verwende es
                accessToken = storedAccessToken;
                initializeSpotifySdk();
            } else {
                // Andernfalls, zeige den Login-Bildschirm
                showScreen(loginScreen);
            }

            // Initialen Check für Ausrichtung und Vollbild
            checkOrientationAndFullscreen();
        };

        // Message Box (Ersatz für alert())
        function alert(message) {
            const existingMessageBox = document.getElementById('custom-message-box');
            if (existingMessageBox) {
                existingMessageBox.remove();
            }

            const messageBox = document.createElement('div');
            messageBox.id = 'custom-message-box';
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #333;
                color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
                max-width: 80vw;
                text-align: center;
                font-size: 1.1em;
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button style="
                    background-color: var(--spotify-green);
                    color: white;
                    padding: 10px 20px;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 1em;
                ">OK</button>
            `;
            document.body.appendChild(messageBox);

            messageBox.querySelector('button').onclick = () => {
                messageBox.remove();
            };
        }
    </script>
</body>
</html>
