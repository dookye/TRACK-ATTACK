<!DOCTYPE html>
<html lang="de" class="h-full bg-black">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRACK-ATTACK1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        .screen.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }
        .player1-bg { background-color: #3b82f6; }
        .player2-bg { background-color: #ec4899; }
        .score-gradient-bg { background-image: linear-gradient(to right, #3b82f6, #ec4899); }
        .logo-button.inactive {
            filter: blur(3px);
            pointer-events: none;
            transform: scale(1.0);
        }
        @keyframes bounce-in {
            0% { transform: translateY(-200%) scale(0.8); opacity: 0; }
            60% { transform: translateY(10%) scale(1.05); opacity: 1; }
            80% { transform: translateY(-5%) scale(0.95); }
            100% { transform: translateY(0) scale(1); }
        }
        .animate-bounce-in { animation: bounce-in 1s ease-out forwards; }
        @keyframes bounce-click {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.9); }
        }
        .button-bounce { animation: bounce-click 0.3s ease-in-out; }
        @keyframes genre-blink {
            50% { opacity: 0.5; }
        }
        .genre-blinking { animation: genre-blink 0.3s infinite; }
        @keyframes zoom-fade {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .animate-zoom-fade { animation: zoom-fade 4s ease-in-out forwards; }
        @keyframes fade-out {
            from { opacity: 1; } to { opacity: 0; }
        }
        .animate-fade-out { animation: fade-out 1s ease-in-out forwards; }
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }
        #toast.show { opacity: 1; }
        .z-front { 
            z-index: 30; 
        }
    </style>
</head>
<body class="h-full w-full overflow-hidden bg-black text-white select-none">

    <div id="app-container" class="relative h-full w-full">
        <!-- Login Screen -->
        <div id="login-screen" class="screen h-full w-full flex-col justify-center items-center p-4">
            <h1 class="text-3xl md:text-5xl font-bold mb-8 text-center">Willkommen bei TRACK-ATTACK</h1>
            <p class="mb-8 text-center text-gray-300">Bitte logge dich mit deinem Spotify Premium-Account ein, um zu spielen.</p>
            <button id="login-button" class="bg-[#1DB954] text-white font-bold py-4 px-8 rounded-full text-lg hover:bg-[#1ed760] transition-colors">
                Login mit Spotify
            </button>
        </div>

        <!-- Orientation Screen -->
        <div id="orientation-screen" class="screen h-full w-full flex-col justify-center items-center text-center p-4">
            <h2 class="text-2xl font-bold">Bitte drehe dein Gerät in den Landscape-Modus, um zu spielen.</h2>
        </div>

        <!-- Fullscreen Screen -->
        <div id="fullscreen-screen" class="screen h-full w-full flex-col justify-center items-center cursor-pointer p-4 z-30">
            <h2 class="text-3xl font-bold animate-pulse">Klicke, um den Vollbildmodus zu starten</h2>
        </div>
        
        <!-- Game Screens Container -->
        <div id="game-container" class="h-full w-full transition-colors duration-1000">
             <!-- Persistent Logo Button -->
            <div id="logo-container" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 hidden">
                 <img src="https://i.imgur.com/uRiiG6h.png" alt="Logo" id="logo-button" class="logo-button w-32 h-32 md:w-48 md:h-48 cursor-pointer transition-transform duration-200">
            </div>

            <!-- Intro Animation Screen -->
            <div id="intro-screen" class="screen h-full w-full flex-col justify-center items-center">
                 <img src="https://i.imgur.com/uRiiG6h.png" alt="Logo Animation" id="intro-logo" class="w-48 h-48 md:w-64 md:h-64">
            </div>

            <!-- Dice Screen -->
            <div id="dice-screen" class="screen h-full w-full flex-col justify-center items-center p-4">
                <div id="dice-animation-container" class="mb-12">
                    <img src="https://i.imgur.com/yFpPnR9.gif" alt="Würfel Animation" class="w-48 h-48">
                </div>
                <div id="dice-selection-container" class="hidden flex-wrap justify-center items-center gap-4 md:gap-8">
                    <img data-value="3" src="https://i.imgur.com/2p1xLqR.png" alt="Würfel 3" class="dice-option w-24 h-24 md:w-32 md:h-32 cursor-pointer hover:scale-110 transition-transform">
                    <img data-value="4" src="https://i.imgur.com/k6O6VqS.png" alt="Würfel 4" class="dice-option w-24 h-24 md:w-32 md:h-32 cursor-pointer hover:scale-110 transition-transform">
                    <img data-value="5" src="https://i.imgur.com/FzJ0x6D.png" alt="Würfel 5" class="dice-option w-24 h-24 md:w-32 md:h-32 cursor-pointer hover:scale-110 transition-transform">
                    <img data-value="7" src="https://i.imgur.com/XUfsqx5.png" alt="Würfel 7" class="dice-option w-24 h-24 md:w-32 md:h-32 cursor-pointer hover:scale-110 transition-transform">
                </div>
            </div>

            <!-- Genre Screen -->
            <div id="genre-screen" class="screen h-full w-full flex-col justify-center items-center p-4 gap-4">
                 <h2 id="genre-title" class="text-3xl font-bold mb-8 text-center">Wähle ein Genre</h2>
                 <div id="genre-buttons" class="grid grid-cols-2 gap-4 w-full max-w-2xl">
                     </div>
            </div>
            
             <!-- Rate Screen -->
            <div id="rate-screen" class="screen h-full w-full flex-col justify-center items-center p-4">
                <div id="resolution-container" class="hidden absolute top-10 left-1/2 -translate-x-1/2 w-full max-w-md p-4 text-center z-10">
                    <img id="album-cover" src="" alt="Album Cover" class="w-40 h-40 mx-auto mb-4 rounded-lg shadow-lg">
                    <h3 id="track-title" class="text-2xl font-bold"></h3>
                    <p id="track-artist" class="text-xl"></p>
                </div>
                <div id="action-buttons" class="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4 z-30">
                     <button id="resolve-button" class="hidden bg-yellow-500 text-black font-bold py-3 px-6 rounded-full hover:bg-yellow-400">AUFLÖSEN</button>
                     <button id="correct-button" class="hidden bg-green-500 text-white font-bold py-3 px-6 rounded-full hover:bg-green-400">RICHTIG</button>
                     <button id="wrong-button" class="hidden bg-red-500 text-white font-bold py-3 px-6 rounded-full hover:bg-red-400">FALSCH</button>
                </div>
            </div>

             <!-- Speed Round/Timer Screen -->
            <div id="overlay-screen" class="screen absolute inset-0 h-full w-full flex-col justify-center items-center z-40 bg-black/50">
                <h2 id="overlay-text" class="text-6xl md:text-9xl font-black text-white drop-shadow-lg"></h2>
            </div>
        </div>

        <!-- Score Screen -->
        <div id="score-screen" class="screen h-full w-full flex justify-around items-center score-gradient-bg p-4">
            <div class="text-center">
                <h2 class="text-3xl md:text-5xl font-bold mb-4">Spieler 1</h2>
                <p id="player1-score" class="text-7xl md:text-9xl font-black"></p>
            </div>
            <div class="text-center">
                <h2 class="text-3xl md:text-5xl font-bold mb-4">Spieler 2</h2>
                <p id="player2-score" class="text-7xl md:text-9xl font-black"></p>
            </div>
        </div>

    </div>
    
    <div id="toast"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const CLIENT_ID = '53257f6a1c144d3f929a60d691a0c6f6';
        const REDIRECT_URI = 'https://dookye.github.io/TRACK-ATTACK/';
        
        const screens = {
            login: document.getElementById('login-screen'),
            orientation: document.getElementById('orientation-screen'),
            fullscreen: document.getElementById('fullscreen-screen'),
            intro: document.getElementById('intro-screen'),
            dice: document.getElementById('dice-screen'),
            genre: document.getElementById('genre-screen'),
            rate: document.getElementById('rate-screen'),
            score: document.getElementById('score-screen'),
            overlay: document.getElementById('overlay-screen'),
        };

        const gameContainer = document.getElementById('game-container');
        const logoContainer = document.getElementById('logo-container');
        const logoButton = document.getElementById('logo-button');
        const loginButton = document.getElementById('login-button');

        let player;
        let deviceId;
        let accessToken;
        let playerSdkReady = false; // Flag for Spotify SDK global callback readiness
        let playerConnected = false; // Flag for successful player connection

        const gameState = {
            currentPlayer: 1,
            round: 1,
            player1Score: 0,
            player2Score: 0,
            selectedDice: 0,
            listeningAttempts: 0,
            currentTrack: null,
            isSpeedRound: false,
            speedRoundTimer: null,
            totalRounds: 10,
            hasInitialAnimationPlayed: false,
        };
        
        const genres = [
            { name: "Punk Rock (90's & 00')", playlists: ['39sVxPTg7BKwrf2MfgrtcD', '7ITmaFa2rOhAmKmUUCG9E'] },
            { name: 'Pop Hits 2000-2025', playlists: ['6mtYuOxzl58vSGnEDtZ9uB', '34NbomaTu7YuOYnky8nLXL'] },
            { name: 'Die größten Hits aller Zeiten', playlists: ['2si7ChS6Y0hPBt4FsobXpg', '2y09fNnXHvoqc1WGHvbhkZ'] },
            { name: 'Disney Songs', playlists: ['3Bilb56eeS7db5f3DTEwMR', '2bhbwexk7c6yJrEB4CtuY8'] }
        ];

        function showScreen(screenName) {
            console.log('Attempting to show screen:', screenName);
            Object.values(screens).forEach(s => {
                s.classList.remove('active');
                s.classList.remove('z-front'); 
            });
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
                if (screenName === 'dice' || screenName === 'genre' || screenName === 'rate') {
                    screens[screenName].classList.add('z-front');
                }
                console.log('Screen shown:', screenName);
            } else if (screenName === null) {
                console.log('All screens hidden.');
            } else {
                console.warn('Attempted to show unknown screen:', screenName);
            }
        }

        function showToast(message) {
            console.log('Toast:', message);
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        loginButton.addEventListener('click', async () => {
            console.log('Login button clicked.');
            showToast('Verbinde mit Spotify...');
            showScreen(null); // Hide all screens immediately upon click
            
            const codeVerifier = generateRandomString(128);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            window.sessionStorage.setItem('code_verifier', codeVerifier);
            const args = new URLSearchParams({
                response_type: 'code',
                client_id: CLIENT_ID,
                scope: 'streaming user-read-email user-read-private user-read-playback-state user-modify-playback-state playlist-read-private playlist-read-collaborative',
                redirect_uri: REDIRECT_URI,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge,
            });
            window.location = 'https://accounts.spotify.com/authorize?' + args;
        });

        // Definiere onSpotifyWebPlaybackSDKReady global und frühzeitig
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log('Spotify Web Playback SDK is ready.');
            player = new Spotify.Player({
                name: 'TRACK-ATTACK',
                getOAuthToken: cb => { cb(accessToken); },
                volume: 0.5
            });

            player.addListener('ready', ({ device_id }) => {
                console.log('Spotify Player is ready with device ID:', device_id);
                deviceId = device_id;
                playerSdkReady = true; 
                // Wenn Token schon da ist, Player verbinden
                if (accessToken) {
                    console.log('Access token present on SDK ready, attempting connection...');
                    attemptPlayerConnection();
                } else {
                    console.log('No access token on SDK ready, waiting for handleRedirect.');
                }
            });

            player.addListener('not_ready', ({ device_id }) => {
                 showToast('Gerät nicht bereit.');
                 playerConnected = false;
                 console.error('Spotify Player not ready, device_id:', device_id);
                 showScreen('login');
            });
            player.addListener('initialization_error', ({ message }) => { showToast('Initialisierungsfehler: ' + message); playerConnected = false; console.error('Spotify Init Error:', message); showScreen('login'); });
            player.addListener('authentication_error', ({ message }) => { showToast('Authentifizierungsfehler: ' + message); showScreen('login'); playerConnected = false; console.error('Spotify Auth Error:', message); });
            player.addListener('account_error', ({ message }) => { showToast('Account-Fehler: ' + message); playerConnected = false; console.error('Spotify Account Error:', message); showScreen('login'); });
        };

        // Funktion, um Player-Verbindung zu versuchen und fortzufahren
        function attemptPlayerConnection() {
            console.log('attemptPlayerConnection called. SDK Ready:', playerSdkReady, 'Access Token:', !!accessToken, 'Player Connected:', playerConnected);
            if (playerConnected) {
                console.log('Player already connected, proceeding to checkDeviceOrientation.');
                checkDeviceOrientation();
                return;
            }

            if (playerSdkReady && accessToken) {
                showToast('Verbinde Spotify Player...');
                player.connect().then(success => {
                    if (success) {
                        console.log('Spotify Player erfolgreich verbunden!');
                        playerConnected = true;
                        showToast('Player bereit!');
                        checkDeviceOrientation(); // Erst hier zum nächsten Schritt wechseln nach erfolgreicher Verbindung
                    } else {
                        showToast('Verbindung zum Spotify Player fehlgeschlagen.');
                        playerConnected = false;
                        console.error('Player connection unsuccessful, but no error thrown.');
                        showScreen('login');
                    }
                }).catch(err => {
                    showToast('Fehler beim Verbinden des Spotify Players: ' + err.message);
                    playerConnected = false;
                    console.error('Error connecting Spotify Player:', err);
                    showScreen('login');
                });
            } else {
                console.log('Conditions not met for player connection. SDK Ready:', playerSdkReady, 'Access Token:', !!accessToken);
                // If this is called prematurely (e.g., from handleRedirect before SDK is ready),
                // it just logs and waits for onSpotifyWebPlaybackSDKReady to fire.
                // It does *not* explicitly show 'login' here as it might still be loading.
            }
        }

        async function handleRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            console.log('handleRedirect called. Code in URL:', !!code, 'Stored Token:', !!window.sessionStorage.getItem('access_token'));

            if (code) {
                showToast('Verarbeite Spotify-Code...');
                showScreen(null); // Clear screen while processing
                
                const codeVerifier = window.sessionStorage.getItem('code_verifier');
                const body = new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    client_id: CLIENT_ID,
                    code_verifier: codeVerifier,
                });
                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: body,
                    });
                    if (!response.ok) { 
                        const errorData = await response.json();
                        throw new Error(`HTTP status ${response.status}: ${errorData.error_description || 'Unknown error'}`); 
                    }
                    const data = await response.json();
                    accessToken = data.access_token;
                    window.sessionStorage.setItem('access_token', accessToken);
                    window.history.replaceState({}, document.title, window.location.pathname); 
                    console.log('Access token obtained, attempting player connection.');
                    attemptPlayerConnection();
                } catch (error) {
                    showToast('Fehler bei der Authentifizierung: ' + error.message);
                    console.error('Auth token exchange failed:', error);
                    showScreen('login');
                }
            } else if (window.sessionStorage.getItem('access_token')) {
                showToast('Lade gespeicherten Spotify-Token...');
                showScreen(null); // Clear screen while processing
                
                accessToken = window.sessionStorage.getItem('access_token');
                console.log('Stored access token found, attempting player connection.');
                attemptPlayerConnection();
            } else {
                console.log('No code or stored token found, showing login screen.');
                showScreen('login'); // Fallback: Keine Anmelde-Informationen, zeige Login-Bildschirm
            }
        }
        
        function checkDeviceOrientation() {
            console.log('checkDeviceOrientation called. Player connected:', playerConnected);
            if (playerConnected) {
                const orientationCheck = () => {
                    if (window.matchMedia("(orientation: portrait)").matches && window.innerHeight > window.innerWidth) {
                        showScreen('orientation');
                    } else {
                        showScreen('fullscreen');
                    }
                };
                orientationCheck();
                window.removeEventListener('resize', orientationCheck); 
                window.addEventListener('resize', orientationCheck);
            } else {
                showToast('Player nicht verbunden. Bitte neu anmelden.');
                console.error('checkDeviceOrientation called but player not connected.');
                showScreen('login');
            }
        }

        screens.fullscreen.addEventListener('click', () => {
            console.log('Fullscreen button clicked.');
            document.documentElement.requestFullscreen().then(() => {
                if (!gameState.hasInitialAnimationPlayed) {
                    showScreen('intro');
                    document.getElementById('intro-logo').classList.add('animate-bounce-in');
                    setTimeout(() => {
                        document.getElementById('intro-logo').classList.remove('animate-bounce-in');
                        showScreen(null);
                        logoContainer.style.display = 'block';
                        logoButton.classList.add('animate-bounce-in');
                        setTimeout(() => {
                            logoButton.classList.remove('animate-bounce-in');
                            logoButton.onclick = () => {
                                logoButton.classList.add('button-bounce');
                                setTimeout(() => logoButton.classList.remove('button-bounce'), 300);
                                startFirstRound();
                            };
                            gameState.hasInitialAnimationPlayed = true;
                            console.log('Initial logo animation completed. Game ready to start.');
                        }, 1000);
                    }, 1500); 
                } else {
                    console.log('Initial logo animation already played. Skipping intro animation.');
                    showScreen(null);
                    logoContainer.style.display = 'block';
                    logoButton.onclick = () => {
                        logoButton.classList.add('button-bounce');
                        setTimeout(() => logoButton.classList.remove('button-bounce'), 300);
                        startFirstRound();
                    };
                    setButtonState(logoButton, true);
                }
            }).catch(err => {
                 showToast('Vollbildmodus konnte nicht gestartet werden.');
                 console.error('Fullscreen request failed:', err);
                 // Fallback if fullscreen fails: proceed directly to intro or main logo
                 if (!gameState.hasInitialAnimationPlayed) {
                     showScreen('intro');
                     document.getElementById('intro-logo').classList.add('animate-bounce-in');
                     setTimeout(() => {
                        document.getElementById('intro-logo').classList.remove('animate-bounce-in');
                        showScreen(null);
                        logoContainer.style.display = 'block';
                        logoButton.classList.add('animate-bounce-in');
                        setTimeout(() => {
                            logoButton.classList.remove('animate-bounce-in');
                            logoButton.onclick = () => {
                                logoButton.classList.add('button-bounce');
                                setTimeout(() => logoButton.classList.remove('button-bounce'), 300);
                                startFirstRound();
                            };
                            gameState.hasInitialAnimationPlayed = true;
                        }, 1000);
                     }, 1500);
                 } else {
                    showScreen(null);
                    logoContainer.style.display = 'block';
                    logoButton.onclick = () => {
                        logoButton.classList.add('button-bounce');
                        setTimeout(() => logoButton.classList.remove('button-bounce'), 300);
                        startFirstRound();
                    };
                    setButtonState(logoButton, true);
                 }
            });
        });

        function startFirstRound() {
            console.log('Starting first round.');
            logoButton.onclick = null;
            setButtonState(logoButton, false);
            startNewTurn();
        }
        
        function resetGameState() {
            console.log('Resetting game state.');
            gameState.currentPlayer = 1;
            gameState.round = 1;
            gameState.player1Score = 0;
            gameState.player2Score = 0;
            // gameState.hasInitialAnimationPlayed remains true for subsequent games in same session
        }

        function startNewTurn() {
            console.log('Starting new turn. Current player:', gameState.currentPlayer, 'Round:', gameState.round);
            if (gameState.currentPlayer === 2) {
                gameState.round++;
            }
            if (gameState.round > gameState.totalRounds) {
                console.log('All rounds completed, showing end screen.');
                showEndScreen();
                return;
            }
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            
            gameState.isSpeedRound = (gameState.round === 3 && gameState.currentPlayer === 1) || (gameState.round === 7 && gameState.currentPlayer === 2);
            
            showToast(`Spieler ${gameState.currentPlayer}, Runde ${gameState.round}`);
            gameContainer.className = `h-full w-full transition-colors duration-1000 ${gameState.currentPlayer === 1 ? 'player1-bg' : 'player2-bg'}`;

            setTimeout(() => showDiceScreen(), 1000);
        }

        function showDiceScreen() {
            console.log('Showing dice screen.');
            showScreen('dice');
            const diceAnim = document.getElementById('dice-animation-container');
            const diceSelect = document.getElementById('dice-selection-container');
            diceAnim.style.display = 'block';
            diceSelect.style.display = 'none';

            setTimeout(() => {
                diceAnim.style.display = 'none';
                diceSelect.style.display = 'flex';
                console.log('Dice selection ready.');
            }, 4000);
        }

        document.querySelectorAll('.dice-option').forEach(dice => {
            dice.addEventListener('click', (e) => {
                console.log('Dice selected:', e.target.dataset.value);
                e.target.classList.add('button-bounce');
                setTimeout(() => e.target.classList.remove('button-bounce'), 300);
                gameState.selectedDice = parseInt(e.target.dataset.value);
                gameState.listeningAttempts = gameState.selectedDice;
                setTimeout(showGenreScreen, 500);
            });
        });

        function showGenreScreen() {
            console.log('Showing genre screen.');
            showScreen('genre');
            const genreButtonsContainer = document.getElementById('genre-buttons');
            genreButtonsContainer.innerHTML = '';
            genres.forEach((genre, index) => {
                const button = document.createElement('button');
                button.textContent = genre.name;
                button.dataset.index = index;
                button.className = 'genre-button bg-white/20 text-white font-bold p-4 rounded-lg text-center hover:bg-white/40 transition-colors text-sm md:text-lg';
                genreButtonsContainer.appendChild(button);
            });

            const genreTitle = document.getElementById('genre-title');
            const allGenreButtons = document.querySelectorAll('.genre-button');

            if (gameState.selectedDice === 7) {
                genreTitle.textContent = "Wähle dein Genre";
                allGenreButtons.forEach(button => {
                    button.onclick = (e) => handleGenreSelection(e.target, e.target.dataset.index);
                });
            } else {
                genreTitle.textContent = "Genre wird gewählt...";
                const randomIndex = Math.floor(Math.random() * genres.length);
                const selectedButton = allGenreButtons[randomIndex];

                allGenreButtons.forEach(b => b.classList.add('genre-blinking'));

                setTimeout(() => {
                    allGenreButtons.forEach(b => {
                        b.classList.remove('genre-blinking');
                        if (b !== selectedButton) {
                            b.disabled = true;
                            b.style.opacity = '0.5';
                        }
                    });
                    genreTitle.textContent = "Dein Genre ist:";
                    selectedButton.onclick = (e) => handleGenreSelection(e.target, randomIndex);
                    console.log('Auto-selected genre:', selectedButton.textContent);
                }, 4000);
            }
        }
        
        async function handleGenreSelection(button, genreIndex) {
            console.log('Genre selected:', genres[genreIndex].name);
            button.classList.add('button-bounce');
            setTimeout(() => button.classList.remove('button-bounce'), 300);
            
            showToast('Lade Song...');
            const selectedGenre = genres[genreIndex];
            const playlistId = selectedGenre.playlists[Math.floor(Math.random() * selectedGenre.playlists.length)];
            
            try {
                const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to load playlist: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                }
                const data = await response.json();
                const tracks = data.items.filter(item => item.track && item.track.preview_url !== null);
                if (tracks.length === 0) {
                     const allTracks = data.items.filter(item => item.track);
                     if (allTracks.length > 0) {
                        gameState.currentTrack = allTracks[Math.floor(Math.random() * allTracks.length)].track;
                        showToast('Warnung: Kein Vorschaulink für diesen Song verfügbar, verwende den gesamten Song.');
                        console.warn('No preview URL for tracks in playlist. Using full track (might not play in Web Playback SDK):', gameState.currentTrack.name);
                     } else {
                        throw new Error('Keine Tracks in dieser Playlist oder alle unspielbar.');
                     }
                } else {
                    gameState.currentTrack = tracks[Math.floor(Math.random() * tracks.length)].track;
                    console.log('Selected track:', gameState.currentTrack.name);
                }
                setTimeout(startRatePhase, 500);
            } catch (error) {
                showToast('Fehler beim Laden der Playlist oder Song: ' + error.message);
                console.error('Error loading playlist/track:', error);
                startNewTurn(); // Starte neuen Zug, um nicht stecken zu bleiben
            }
        }

        function startRatePhase() {
            console.log('Starting rate phase. Is speed round:', gameState.isSpeedRound);
            if (gameState.isSpeedRound) {
                showOverlay("Speed-Round", 4000, () => {
                    showRateScreen();
                    startSpeedRoundTimer();
                });
            } else {
                showRateScreen();
            }
        }

        function showRateScreen() {
            console.log('Showing rate screen.');
            showScreen('rate');
            setButtonState(logoButton, true);

            logoButton.onclick = () => {
                console.log('Logo button clicked for playing track.');
                if (gameState.listeningAttempts > 0) {
                    logoButton.classList.add('button-bounce');
                    setTimeout(() => logoButton.classList.remove('button-bounce'), 300);
                    playTrackSnippet();
                } else {
                    showToast('Keine Hörversuche mehr übrig.');
                }
            };

            const resolveBtn = document.getElementById('resolve-button');
            resolveBtn.classList.remove('hidden');
            resolveBtn.onclick = (e) => {
                console.log('Resolve button clicked.');
                e.target.classList.add('button-bounce');
                setTimeout(() => e.target.classList.remove('button-bounce'), 300);
                handleResolution();
            };
        }

        async function playTrackSnippet() {
            if (!gameState.currentTrack) {
                console.error('No current track to play.');
                showToast('Kein Song zum Abspielen gefunden.');
                setButtonState(logoButton, true); // Ermöglicht erneuten Versuch
                return;
            }
            console.log('Playing track snippet. Attempts left:', gameState.listeningAttempts);
            setButtonState(logoButton, false);
            gameState.listeningAttempts--;
            showToast(`Hörversuche übrig: ${gameState.listeningAttempts}`);

            const songDuration = gameState.selectedDice === 7 ? 2000 : 7000;
            const trackDurationMs = gameState.currentTrack.duration_ms;
            // Ensure randomPosition doesn't go beyond track length or cause negative duration
            const randomPosition = Math.floor(Math.random() * Math.max(0, trackDurationMs - songDuration));
            
            try {
                // Ensure deviceId is available
                if (!deviceId) {
                    showToast('Spotify-Gerät nicht verfügbar. Bitte lade die Seite neu.');
                    console.error('No device ID available for playback.');
                    setButtonState(logoButton, true);
                    return;
                }

                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ uris: [gameState.currentTrack.uri], position_ms: randomPosition }),
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                console.log(`Playing ${gameState.currentTrack.name} from position ${randomPosition} for ${songDuration}ms.`);

                setTimeout(async () => {
                    await player.pause();
                    console.log('Playback paused.');
                    if (gameState.listeningAttempts > 0) {
                        setButtonState(logoButton, true);
                    } else {
                        setButtonState(logoButton, false); 
                        handleResolution(); // Automatische Auflösung nach dem letzten Versuch
                        console.log('Last attempt, automatic resolution triggered.');
                    }
                }, songDuration);
            } catch(e) {
                 showToast('Fehler bei der Wiedergabe: ' + e.message);
                 console.error('Playback error:', e);
                 setButtonState(logoButton, true); // Ermöglicht erneuten Versuch
            }
        }

        function handleResolution() {
            console.log('Handling resolution.');
            if(gameState.isSpeedRound && gameState.speedRoundTimer) {
                clearInterval(gameState.speedRoundTimer);
                gameState.speedRoundTimer = null;
                console.log('Speed Round timer cleared.');
            }
            if (player) { // Ensure player exists before pausing
                player.pause();
            }
            setButtonState(logoButton, false); 
            
            // Punkteberechnung: max. Punkte vom Würfel, Abzug 1 Punkt pro erneutem Hörversuch
            // initial attempts = selectedDice.
            // attempts made = selectedDice - listeningAttempts
            // points = selectedDice - (attempts made - 1) => if 1st attempt, 0 points deducted; if 2nd, 1 point deducted.
            // min points = 1.
            const attemptsMade = gameState.selectedDice - gameState.listeningAttempts;
            const points = Math.max(1, gameState.selectedDice - (attemptsMade > 0 ? (attemptsMade - 1) : 0));
            console.log(`Resolution: Selected Dice=${gameState.selectedDice}, Attempts Left=${gameState.listeningAttempts}, Attempts Made=${attemptsMade}, Points=${points}`);


            document.getElementById('resolve-button').classList.add('hidden');
            document.getElementById('correct-button').classList.remove('hidden');
            document.getElementById('wrong-button').classList.remove('hidden');

            const resolutionContainer = document.getElementById('resolution-container');
            document.getElementById('album-cover').src = gameState.currentTrack.album.images[0]?.url || 'https://placehold.co/160x160/000000/FFFFFF?text=No+Cover'; // Fallback
            document.getElementById('track-title').textContent = gameState.currentTrack.name;
            document.getElementById('track-artist').textContent = gameState.currentTrack.artists.map(a => a.name).join(', ');
            resolutionContainer.classList.remove('hidden');

            document.getElementById('correct-button').onclick = (e) => {
                console.log('Correct button clicked.');
                 e.target.classList.add('button-bounce');
                setTimeout(() => e.target.classList.remove('button-bounce'), 300);
                if (gameState.currentPlayer === 1) gameState.player1Score += points;
                else gameState.player2Score += points;
                showToast(`Spieler ${gameState.currentPlayer} hat ${points} Punkte erhalten!`);
                endTurn();
            };
            document.getElementById('wrong-button').onclick = (e) => {
                console.log('Wrong button clicked.');
                 e.target.classList.add('button-bounce');
                setTimeout(() => e.target.classList.remove('button-bounce'), 300);
                showToast(`Spieler ${gameState.currentPlayer} hat 0 Punkte erhalten.`);
                endTurn();
            };
        }

        function startSpeedRoundTimer() {
            let timeLeft = 10;
            const overlayText = document.getElementById('overlay-text');
            showScreen('overlay');
            overlayText.textContent = timeLeft;
            overlayText.classList.remove('animate-zoom-fade');
            void overlayText.offsetWidth; // Trigger reflow
            overlayText.style.animation = 'none';

            gameState.speedRoundTimer = setInterval(() => {
                timeLeft--;
                overlayText.textContent = timeLeft;
                if (timeLeft <= 0) {
                    console.log('Speed Round timer ended.');
                    clearInterval(gameState.speedRoundTimer);
                    gameState.speedRoundTimer = null;
                    showScreen('rate'); // Zurück zum Rate-Bildschirm
                    handleResolution(); // Automatische Auflösung
                }
            }, 1000);
            console.log('Speed Round timer started.');
        }

        function endTurn() {
            console.log('Ending turn.');
            hideResolutionUI();
            // Der Rundenwechsel wurde in startNewTurn() verschoben, um die Logik zu straffen.
            setTimeout(startNewTurn, 1000);
        }
        
        function showEndScreen() {
            console.log('Showing end screen. Final scores - Player 1:', gameState.player1Score, 'Player 2:', gameState.player2Score);
            showScreen('score');
            document.getElementById('player1-score').textContent = gameState.player1Score;
            document.getElementById('player2-score').textContent = gameState.player2Score;
            
            setTimeout(() => {
                screens.score.classList.add('animate-fade-out');
                setTimeout(() => {
                     screens.score.classList.remove('animate-fade-out');
                     resetGameState();
                     gameContainer.className = 'h-full w-full transition-colors duration-1000 bg-black';
                     // Logo-Button für neues Spiel bereitstellen, OHNE erneute Animation
                     logoButton.onclick = () => {
                        logoButton.classList.add('button-bounce');
                        setTimeout(() => logoButton.classList.remove('button-bounce'), 300);
                        startFirstRound();
                     };
                     setButtonState(logoButton, true);
                     console.log('Game ended, reset for new game.');
                }, 1000);
            }, 7000);
        }

        function showOverlay(text, duration, callback) {
            console.log('Showing overlay:', text);
            const overlayText = document.getElementById('overlay-text');
            overlayText.textContent = text;
            overlayText.classList.remove('animate-zoom-fade');
            void overlayText.offsetWidth; // Trigger reflow
            overlayText.classList.add('animate-zoom-fade');
            showScreen('overlay');
            setTimeout(() => {
                showScreen(null); // Overlay ausblenden
                if (callback) callback();
            }, duration);
        }

        function setButtonState(button, isActive) {
            if (isActive) {
                button.classList.remove('inactive');
                button.style.cursor = 'pointer'; // Make cursor visible when active
            } else {
                button.classList.add('inactive');
                button.style.cursor = 'default'; // Hide cursor when inactive
            }
        }

        function hideResolutionUI() {
             document.getElementById('resolution-container').classList.add('hidden');
             document.getElementById('resolve-button').classList.add('hidden');
             document.getElementById('correct-button').classList.add('hidden');
             document.getElementById('wrong-button').classList.add('hidden');
        }

        handleRedirect(); // Rufe handleRedirect sofort beim DOMContentLoaded auf
    });
    </script>
</body>
</html>
